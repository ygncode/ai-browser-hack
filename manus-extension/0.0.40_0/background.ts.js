var yt=Object.defineProperty;var wt=(r,e,t)=>e in r?yt(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var g=(r,e,t)=>wt(r,typeof e!="symbol"?e+"":e,t);import{l as a,a as E,e as $,s as Q,g as ne,b as kt}from"./sendMessage.js";import{t as bt,c as je,f as St,a as _t,M as vt,L as Et}from"./helper.js";import{e as Tt,u as Ct,g as j,a as U,b as $e,c as Mt,d as qe,m as At,f as xt,h as Rt}from"./chromeAsync.js";import{b as q,D as Bt,t as J,d as me,g as Nt}from"./token.js";import{i as Lt}from"./manus.js";import{a as Pt,b as Ot,c as Dt,d as It}from"./typeGuards.js";class Ft{constructor(e=1e3){g(this,"slowQueryThreshold");this.slowQueryThreshold=e}async execute(e,t,s,n){const o=await n(),i=s.getDuration();return i>this.slowQueryThreshold&&a.warn(`[Performance] Slow message handler: ${s.messageType} took ${i}ms (threshold: ${this.slowQueryThreshold}ms)`),o}}const de={button:"#FF6B6B",input:"#4ECDC4",select:"#45B7D1",a:"#96CEB4",textarea:"#FF8C42",default:"#DDA0DD"};function Z(r,e,t){return Math.max(e,Math.min(t,r))}function Ut(r,e){const t=r.toLowerCase();if(t==="input"&&e){const s=e.toLowerCase();if(s==="button"||s==="submit")return de.button}return de[t]??de.default}async function $t(r){const e=r.split(",")[1];if(!e)throw new Error("Invalid dataUrl format");const t=atob(e),s=new Uint8Array(t.length);for(let o=0;o<t.length;o++)s[o]=t.charCodeAt(o);const n=new Blob([s],{type:"image/png"});return createImageBitmap(n)}function qt(r){return new Promise((e,t)=>{const s=new FileReader;s.onload=()=>e(s.result),s.onerror=()=>t(new Error("Failed to convert blob to data URL")),s.readAsDataURL(r)})}function ee(r,e,t,s,n,o,i){if(e===s){const[c,u]=t<n?[t,n]:[n,t];let h=c;for(;h<u;){const d=Math.min(h+o,u);r.beginPath(),r.moveTo(e,h),r.lineTo(e,d),r.stroke(),h+=o+i}}else{const[c,u]=e<s?[e,s]:[s,e];let h=c;for(;h<u;){const d=Math.min(h+o,u);r.beginPath(),r.moveTo(h,t),r.lineTo(d,t),r.stroke(),h+=o+i}}}function Ht(r,e,t,s,n,o){r.strokeStyle=o,r.lineWidth=2,ee(r,e,t,s,t,4,8),ee(r,s,t,s,n,4,8),ee(r,s,n,e,n,4,8),ee(r,e,n,e,t,4,8)}function Vt(r,e,t,s,n,o,i,c,u){const h=e.toString(),d=n-t,l=o-s,p=Math.max(10,Math.min(20,Math.round(c*.01)));r.font=`bold ${p}px sans-serif`;const A=r.measureText(h).width,O=p,x=Math.max(4,Math.min(10,Math.round(c*.005))),y=A+x*2,w=O+x*2;let S=t+Math.floor((d-y)/2),_;const R=5;if(d<60||l<30){const b=s-w-R;_=b<0?o+R:b}else _=s+2;let B=S+y,C=_+w;if(S<0){const b=-S;S+=b,B+=b}if(_<0){const b=-_;_+=b,C+=b}if(B>c){const b=B-c;S-=b,B-=b}if(C>u){const b=C-u;_-=b,C-=b}r.fillStyle=i,r.fillRect(S,_,y,w),r.strokeStyle="white",r.lineWidth=2,r.strokeRect(S,_,y,w),r.fillStyle="white",r.textBaseline="top";const D=S+Math.floor((y-A)/2),H=_+Math.floor((w-O)/2);r.fillText(h,D,H)}function Wt(r,e,t,s,n){const o=Z(Math.round(e.x*t),0,s),i=Z(Math.round(e.y*t),0,n),c=Z(Math.round((e.x+e.width)*t),0,s),u=Z(Math.round((e.y+e.height)*t),0,n);if(c-o<1||u-i<1)return;const h=Ut(e.tagName,e.inputType);Ht(r,o,i,c,u,h),Vt(r,e.index,o,i,c,u,h,s,n)}async function zt(r,e,t){const s=await $t(r),n=new OffscreenCanvas(s.width,s.height),o=n.getContext("2d");if(!o)throw new Error("Failed to get canvas 2d context");o.drawImage(s,0,0);const i=Math.min(t.scaleX,t.scaleY);for(const h of e)Wt(o,h,i,s.width,s.height);const c=await n.convertToBlob({type:"image/png"}),u=await qt(c);return s.close(),u}function Gt(r,e,t=!1,s=!1){const n=new globalThis.TextEncoder,o=n.encode(r);if(o.length<=e)return r;const i=o.length-e,c=s?`...${i} bytes truncated...`:"...";if(t){let d=0,l=r.length;for(;l>0&&d<e;)l-=1,d+=n.encode(r[l]).length;return d>e&&(l+=1),c+r.slice(l)}let u=0,h=0;for(;h<r.length&&u<e;)u+=n.encode(r[h]).length,h+=1;return u>e&&(h-=1),r.slice(0,h)+c}function Kt(r){return{Command:"Meta",Cmd:"Meta",Ctrl:"Control",Option:"Alt"}[r]||r}function Yt(r){let e=0;for(const t of r)switch(t){case"Alt":e|=1;break;case"Control":e|=2;break;case"Meta":e|=4;break;case"Shift":e|=8;break}return e}function Xt(r){const e={Enter:{key:"Enter",code:"Enter",keyCode:13},Escape:{key:"Escape",code:"Escape",keyCode:27},Backspace:{key:"Backspace",code:"Backspace",keyCode:8},Tab:{key:"Tab",code:"Tab",keyCode:9},Space:{key:" ",code:"Space",keyCode:32}," ":{key:" ",code:"Space",keyCode:32},ArrowUp:{key:"ArrowUp",code:"ArrowUp",keyCode:38},ArrowDown:{key:"ArrowDown",code:"ArrowDown",keyCode:40},ArrowLeft:{key:"ArrowLeft",code:"ArrowLeft",keyCode:37},ArrowRight:{key:"ArrowRight",code:"ArrowRight",keyCode:39},Delete:{key:"Delete",code:"Delete",keyCode:46},Home:{key:"Home",code:"Home",keyCode:36},End:{key:"End",code:"End",keyCode:35},PageUp:{key:"PageUp",code:"PageUp",keyCode:33},PageDown:{key:"PageDown",code:"PageDown",keyCode:34},Shift:{key:"Shift",code:"ShiftLeft",keyCode:16},Control:{key:"Control",code:"ControlLeft",keyCode:17},Alt:{key:"Alt",code:"AltLeft",keyCode:18},Meta:{key:"Meta",code:"MetaLeft",keyCode:91},F1:{key:"F1",code:"F1",keyCode:112},F2:{key:"F2",code:"F2",keyCode:113},F3:{key:"F3",code:"F3",keyCode:114},F4:{key:"F4",code:"F4",keyCode:115},F5:{key:"F5",code:"F5",keyCode:116},F6:{key:"F6",code:"F6",keyCode:117},F7:{key:"F7",code:"F7",keyCode:118},F8:{key:"F8",code:"F8",keyCode:119},F9:{key:"F9",code:"F9",keyCode:120},F10:{key:"F10",code:"F10",keyCode:121},F11:{key:"F11",code:"F11",keyCode:122},F12:{key:"F12",code:"F12",keyCode:123},Insert:{key:"Insert",code:"Insert",keyCode:45},CapsLock:{key:"CapsLock",code:"CapsLock",keyCode:20},NumLock:{key:"NumLock",code:"NumLock",keyCode:144},ScrollLock:{key:"ScrollLock",code:"ScrollLock",keyCode:145},Pause:{key:"Pause",code:"Pause",keyCode:19},ContextMenu:{key:"ContextMenu",code:"ContextMenu",keyCode:93},"`":{key:"`",code:"Backquote",keyCode:192},Backquote:{key:"`",code:"Backquote",keyCode:192},"-":{key:"-",code:"Minus",keyCode:189},Minus:{key:"-",code:"Minus",keyCode:189},"=":{key:"=",code:"Equal",keyCode:187},Equal:{key:"=",code:"Equal",keyCode:187},"[":{key:"[",code:"BracketLeft",keyCode:219},BracketLeft:{key:"[",code:"BracketLeft",keyCode:219},"]":{key:"]",code:"BracketRight",keyCode:221},BracketRight:{key:"]",code:"BracketRight",keyCode:221},"\\":{key:"\\",code:"Backslash",keyCode:220},Backslash:{key:"\\",code:"Backslash",keyCode:220},";":{key:";",code:"Semicolon",keyCode:186},Semicolon:{key:";",code:"Semicolon",keyCode:186},"'":{key:"'",code:"Quote",keyCode:222},Quote:{key:"'",code:"Quote",keyCode:222},",":{key:",",code:"Comma",keyCode:188},Comma:{key:",",code:"Comma",keyCode:188},".":{key:".",code:"Period",keyCode:190},Period:{key:".",code:"Period",keyCode:190},"/":{key:"/",code:"Slash",keyCode:191},Slash:{key:"/",code:"Slash",keyCode:191},Numpad0:{key:"0",code:"Numpad0",keyCode:96},Numpad1:{key:"1",code:"Numpad1",keyCode:97},Numpad2:{key:"2",code:"Numpad2",keyCode:98},Numpad3:{key:"3",code:"Numpad3",keyCode:99},Numpad4:{key:"4",code:"Numpad4",keyCode:100},Numpad5:{key:"5",code:"Numpad5",keyCode:101},Numpad6:{key:"6",code:"Numpad6",keyCode:102},Numpad7:{key:"7",code:"Numpad7",keyCode:103},Numpad8:{key:"8",code:"Numpad8",keyCode:104},Numpad9:{key:"9",code:"Numpad9",keyCode:105},NumpadMultiply:{key:"*",code:"NumpadMultiply",keyCode:106},NumpadAdd:{key:"+",code:"NumpadAdd",keyCode:107},NumpadSubtract:{key:"-",code:"NumpadSubtract",keyCode:109},NumpadDecimal:{key:".",code:"NumpadDecimal",keyCode:110},NumpadDivide:{key:"/",code:"NumpadDivide",keyCode:111},NumpadEnter:{key:"Enter",code:"NumpadEnter",keyCode:13}};if(e[r])return e[r];if(r.length===1){const t=r.toLowerCase(),s=r.toUpperCase();if(t>="a"&&t<="z"){const n=t.charCodeAt(0)-32;return{key:r,code:`Key${s}`,keyCode:n}}if(t>="0"&&t<="9"){const n=t.charCodeAt(0);return{key:r,code:`Digit${t}`,keyCode:n}}}return null}async function Jt(r,e){try{const t=[];for(const o of e){const i=Xt(o);if(!i)return a.error(`Unsupported key: ${o}. Please add it to the key mapping.`),{success:!1,error:`Unsupported key: ${o}. Please add it to the key mapping.`};t.push(i)}const s=e.slice(0,-1),n=Yt(s);for(let o=0;o<t.length;o++){const i=t[o],c=o===t.length-1;await r.send("Input.dispatchKeyEvent",{type:"keyDown",key:i.key,code:i.code,nativeVirtualKeyCode:i.keyCode,windowsVirtualKeyCode:i.keyCode,...c&&n>0?{modifiers:n}:{}})}for(let o=t.length-1;o>=0;o--){const i=t[o],c=o===t.length-1;await r.send("Input.dispatchKeyEvent",{type:"keyUp",key:i.key,code:i.code,nativeVirtualKeyCode:i.keyCode,windowsVirtualKeyCode:i.keyCode,...c&&n>0?{modifiers:n}:{}})}return a.debug(`Dispatched CDP keyboard events for keys: ${e.join("+")}`),{success:!0}}catch(t){const s=t instanceof Error?t.message:String(t);return a.error(`Failed to dispatch CDP key event for keys: ${e.join("+")}`,{error:s}),{success:!1,error:`Failed to dispatch key event via CDP: ${s}`}}}async function Qt(r,e){a.info(`Pressing key "${e}" on tab ${r}`);try{const t=e.split("+").map(s=>Kt(s.trim()));return await Me(r,async s=>await Jt(s,t))}catch(t){const s=t instanceof Error?t.message:String(t);return a.error(`Failed to press key "${e}" on tab ${r}`,{error:s}),{success:!1,error:`Failed to press key: ${s}`}}}const jt="1.3",Zt=60*1e3,es=1920,ts=1080,P=new Map;var Qe;(Qe=chrome.debugger)==null||Qe.onDetach.addListener((r,e)=>{if(r.tabId){const t=P.get(r.tabId);t&&(a.warn(`Debugger detached from tab ${r.tabId}`,{reason:e}),t.detachTimer&&clearTimeout(t.detachTimer),P.delete(r.tabId))}});function He(r,e){e.detachTimer&&clearTimeout(e.detachTimer),e.detachTimer=setTimeout(()=>{a.info(`Detaching CDP session after inactivity timeout for tab ${r}`),Ce(e.target).catch(t=>{a.warn(`Failed to detach CDP session for tab ${r}`,{error:t})}),P.delete(r)},Zt)}async function Ve(r){let e=P.get(r);if(e)return e.lastUsed=Date.now(),He(r,e),e;a.info(`Creating new persistent CDP session for tab ${r}`);const t=await ss(r),s=rs(t);await s.send("Page.enable");const n=await ls(s);return e={target:t,session:s,viewport:n,lastUsed:Date.now()},P.set(r,e),He(r,e),e}async function ss(r){const e={tabId:r};return await new Promise((t,s)=>{chrome.debugger.attach(e,jt,()=>{if(chrome.runtime.lastError){s(new Error(chrome.runtime.lastError.message));return}t()})}),e}function Ce(r){return new Promise(e=>{chrome.debugger.detach(r,()=>{chrome.runtime.lastError&&a.warn("Failed to detach debugger",{error:chrome.runtime.lastError.message,target:r}),e()})})}function rs(r){return{send(e,t){return new Promise((s,n)=>{chrome.debugger.sendCommand(r,e,t,o=>{if(chrome.runtime.lastError){const i=new Error(chrome.runtime.lastError.message);chrome.runtime.lastError.message&&ns(chrome.runtime.lastError.message)&&(i.isDebuggingError=!0),n(i);return}s(o)})})}}}function ns(r){const e=["Debugger is not attached","Target closed","Inspector protocol error","Detached while handling","Cannot access contents of","Target crashed","Debugger session not found","Connection lost"],t=r.toLowerCase();return e.some(s=>t.includes(s.toLowerCase()))}function os(r){if(!/^data:image\/(png|jpeg|jpg|gif|webp);base64,/.test(r))return!1;const t=r.split(",")[1];try{return atob(t),!0}catch{return!1}}async function is(r){if(!os(r))throw new Error("Invalid base64 image format");try{const t=await(await fetch(r)).blob(),s=await createImageBitmap(t),n=Math.max(1,Math.round(s.width)),o=Math.max(1,Math.round(s.height));return{bitmap:s,width:n,height:o}}catch(e){throw new Error(`Failed to decode screenshot: ${e instanceof Error?e.message:"Unknown error"}`)}}function as(r,e,t,s){const n=Number.isFinite(r)&&r>0,o=Number.isFinite(e)&&e>0;if(n&&o)return{width:Math.max(1,Math.round(r)),height:Math.max(1,Math.round(e))};if(n){const i=Math.max(1,Math.round(r)),c=Math.max(1,Math.round(s*i/t));return{width:i,height:c}}if(o){const i=Math.max(1,Math.round(e));return{width:Math.max(1,Math.round(t*i/s)),height:i}}return{width:t,height:s}}async function cs(r,e,t){try{const s=new OffscreenCanvas(e,t),n=s.getContext("2d");if(!n)throw new Error("Failed to get canvas context");n.imageSmoothingEnabled=!0,n.imageSmoothingQuality="high",n.fillStyle="white",n.fillRect(0,0,e,t),n.drawImage(r,0,0,r.width,r.height,0,0,e,t);const o=await s.convertToBlob({type:"image/png"});return await us(o)}catch(s){throw new Error(`Failed to resize screenshot: ${s instanceof Error?s.message:"Unknown error"}`)}}function us(r){return new Promise((e,t)=>{const s=new FileReader;s.onload=()=>e(s.result),s.onerror=()=>t(new Error("Failed to convert blob to data URL")),s.readAsDataURL(r)})}async function hs(r){var e;try{const s=(e=(await r.send("Runtime.evaluate",{expression:"(() => ({ width: window.innerWidth || 0, height: window.innerHeight || 0, devicePixelRatio: window.devicePixelRatio || 1 }))()",returnByValue:!0,awaitPromise:!1})).result)==null?void 0:e.value;if(!s)return null;const n=Number(s.width),o=Number(s.height),i=Number(s.devicePixelRatio);return{width:Number.isFinite(n)&&n>0?Math.round(n):void 0,height:Number.isFinite(o)&&o>0?Math.round(o):void 0,devicePixelRatio:Number.isFinite(i)&&i>0?i:void 0}}catch(t){return a.warn("Failed to evaluate viewport via Runtime.evaluate",{error:t instanceof Error?t.message:t}),null}}function te(r,e){for(const t of r){const s=Number(t);if(Number.isFinite(s)&&s>0)return Math.round(s)}return e}async function Ze(r){var d,l;const e=await r.send("Page.getLayoutMetrics"),t=await hs(r),s=e.cssLayoutViewport??e.layoutViewport,n=e.visualViewport??s,o=te([n==null?void 0:n.clientWidth,s==null?void 0:s.clientWidth,(d=e.contentSize)==null?void 0:d.width],es),i=te([n==null?void 0:n.clientHeight,s==null?void 0:s.clientHeight,(l=e.contentSize)==null?void 0:l.height],ts),c=te([t==null?void 0:t.width,o],o),u=te([t==null?void 0:t.height,i],i),h=(t==null?void 0:t.devicePixelRatio)??1;return a.debug("Read viewport metrics",{cssViewport:`${c}x${u}`,fallbackViewport:`${o}x${i}`,devicePixelRatio:h}),{cssWidth:c,cssHeight:u,devicePixelRatio:h}}async function ls(r){await r.send("Emulation.clearDeviceMetricsOverride").catch(()=>{});const e=await Ze(r);return a.info("Initialized viewport using tab dimensions",{cssViewport:`${e.cssWidth}x${e.cssHeight}`,devicePixelRatio:e.devicePixelRatio}),e}async function ds(r,e){const t=await Ze(r);return e.cssWidth=t.cssWidth,e.cssHeight=t.cssHeight,e.devicePixelRatio=t.devicePixelRatio,e}async function ps(r,e,t,s,n){var Ie,Fe,Ue;const o=await r.send("Page.getLayoutMetrics"),i=o.cssLayoutViewport??o.layoutViewport,c=o.visualViewport??i,u=((Ie=o.visualViewport)==null?void 0:Ie.scale)??1,h=Math.max(0,Math.round((c==null?void 0:c.pageX)??0)),d=Math.max(0,Math.round((c==null?void 0:c.pageY)??0)),l=Math.max(1,e.cssWidth),p=Math.max(1,e.cssHeight),m=Number((Fe=o.contentSize)==null?void 0:Fe.width),A=Number((Ue=o.contentSize)==null?void 0:Ue.height),O=Number.isFinite(m)&&m>0?Math.round(m):l,x=Number.isFinite(A)&&A>0?Math.round(A):p,y=Math.max(l,O),w=Math.max(p,x),S=Math.max(1,y-h),_=Math.max(1,w-d),R=Math.min(l,S),B=Math.min(p,_),C=Math.max(1,R),D=Math.max(1,B),H={format:t,fromSurface:!0,clip:{x:h,y:d,width:C,height:D,scale:1/u}};typeof s=="number"&&(H.quality=s);const{data:b}=await r.send("Page.captureScreenshot",H),V=`data:image/${t};base64,${b}`,v=await is(V),W=as(C,D,v.width,v.height);let K=V,z=v.width,F=v.height;try{n||(K=await cs(v.bitmap,W.width,W.height),z=W.width,F=W.height)}finally{v.bitmap.close()}const Le=Math.max(1,Math.round(C)),Pe=Math.max(1,Math.round(D)),Oe=z/Le,De=F/Pe;return a.debug("Captured viewport screenshot via CDP",{clipX:h,clipY:d,clipWidth:C,clipHeight:D,cssWidth:Le,cssHeight:Pe,devicePixelRatio:e.devicePixelRatio,originalWidth:v.width,originalHeight:v.height,finalWidth:z,finalHeight:F,scaleX:Oe,scaleY:De,useOriginalResolution:n}),{dataUrl:K,scaleX:Oe,scaleY:De,dimensions:{width:z,height:F},originalDimensions:{width:v.width,height:v.height}}}async function Me(r,e){let t=await Ve(r),s=0;const n=2;for(;s<=n;)try{const o=await e(t.session,t.viewport);return a.info(`Handler executed for tab ${r}, session remains active`),o}catch(o){const i=o instanceof Error&&o.isDebuggingError;if(t.detachTimer&&clearTimeout(t.detachTimer),await Ce(t.target).catch(()=>{}),P.delete(r),s++,s>n)throw a.error(`CDP session failed after ${n+1} attempts for tab ${r}`),o;const c=i?1e3:500;await new Promise(u=>setTimeout(u,c));try{t=await Ve(r),a.info(`Created fresh CDP session for retry ${s} on tab ${r}`)}catch(u){throw a.error(`Failed to create fresh CDP session for retry on tab ${r}`,{createError:u}),u}}throw new Error("Unexpected end of retry loop")}async function fs(r,e,t={}){const{format:s="png",quality:n,useOriginalResolution:o=!1}=t,i=await ds(r,e),c=await ps(r,i,s,n,o);return{dataUrl:c.dataUrl,width:c.dimensions.width,height:c.dimensions.height,originalWidth:c.originalDimensions.width,originalHeight:c.originalDimensions.height,scaleX:c.scaleX,scaleY:c.scaleY}}async function et(r){const e=P.get(r);e&&(e.detachTimer&&clearTimeout(e.detachTimer),await Ce(e.target).catch(t=>{a.warn(`Failed to detach CDP session during cleanup for tab ${r}`,{error:t})}),P.delete(r))}async function gs(){const r=Array.from(P.keys()).map(e=>et(e));await Promise.all(r)}const ye="data-manus_clickable",we=["display","visibility","opacity","pointer-events"],ms=new Set(["html","head","body","svg","script","style","link","meta"]),ys=new Set(["a","button","input","textarea","select","option","label","details","summary"]),ws=new Set(["button","link","checkbox","radio","textbox","combobox","listbox","option","menuitem","menuitemcheckbox","menuitemradio","tab","switch","slider","spinbutton","searchbox","treeitem"]);function ks(r,e){return r!=null&&r.index?r.index.includes(e):!1}function bs(r,e){const t={};for(let s=0;s<e.length&&s<we.length;s++){const n=e[s];n>=0&&n<r.length&&(t[we[s]]=r[n])}return t}function Ss(r,e){if(!r)return{};const t={};for(let s=0;s<r.length;s+=2){const n=r[s],o=r[s+1];if(n>=0&&n<e.length){const i=e[n],c=o!==void 0&&o>=0&&o<e.length?e[o]:"";t[i]=c}}return t}function _s(r,e){return!(r.width<=.5||r.height<=.5||e.display==="none"||e.visibility==="hidden"||e.visibility==="collapse"||e.opacity==="0"||e["pointer-events"]==="none")}function vs(r,e,t){var n;if(ms.has(r))return!1;if(e||ys.has(r)||t.contenteditable==="true")return!0;const s=(n=t.role)==null?void 0:n.toLowerCase();return!!(s&&ws.has(s)||t.tabindex!==void 0&&t.tabindex!=="-1")}function Es(r,e){const t=[],{strings:s,documents:n}=r;if(!(s!=null&&s.length)||!(n!=null&&n.length))return t;for(const o of n){const{nodes:i,layout:c}=o;if(!i||!c)continue;const{backendNodeId:u,nodeType:h,nodeName:d,attributes:l,isClickable:p}=i,{nodeIndex:m,bounds:A,styles:O,paintOrders:x}=c,y=new Map;for(let w=0;w<m.length;w++){const S=m[w];y.has(S)||y.set(S,w)}for(let w=0;w<u.length;w++){if(h[w]!==1)continue;const S=d[w];if(S<0||S>=s.length)continue;const _=s[S].toLowerCase(),R=y.get(w);if(R===void 0)continue;const B=A[R];if(!B||B.length<4)continue;const[C,D,H,b]=B,V={x:C/e,y:D/e,width:H/e,height:b/e},v=O[R]||[],W=bs(s,v);if(!_s(V,W))continue;const K=Ss(l[w],s),z=ks(p,w);if(!vs(_,z,K))continue;let F=null;x&&R<x.length&&(F=x[R]),t.push({backendNodeId:u[w],paintOrder:F,yPosition:V.y,xPosition:V.x,tagName:_,id:K.id||null})}}return t}function Ts(r){return[...r].sort((e,t)=>{const s=e.paintOrder!==null?0:1,n=t.paintOrder!==null?0:1;return s!==n?s-n:e.paintOrder!==null&&t.paintOrder!==null&&e.paintOrder!==t.paintOrder?e.paintOrder-t.paintOrder:e.yPosition!==t.yPosition?e.yPosition-t.yPosition:e.xPosition-t.xPosition})}async function Cs(r){try{await r.send("Runtime.evaluate",{expression:`
        (function() {
          const elements = document.querySelectorAll('[${ye}]');
          for (const el of elements) {
            el.removeAttribute('${ye}');
          }
          return elements.length;
        })()
      `,returnByValue:!0})}catch(e){a.debug("Failed to clear existing clickable markers",{error:e})}}async function Ms(r,e){try{await r.send("DOM.setAttributeValue",{nodeId:e,name:ye,value:"true"})}catch(t){a.debug(`Failed to set attribute on node ${e}`,{error:t})}}async function As(r){return Me(r,async(e,t)=>{const s=t.devicePixelRatio||1;await Cs(e),await e.send("DOM.enable",{}),await e.send("CSS.enable",{});try{await e.send("DOM.getDocument",{depth:0,pierce:!0})}catch(l){a.debug("Failed to prime DOM document before snapshot",{error:l})}const n=await e.send("DOMSnapshot.captureSnapshot",{computedStyles:we,includeDOMRects:!0,includePaintOrder:!0});if(!n)return a.warn("Unexpected empty snapshot when capturing DOM snapshot"),0;const o=Es(n,s),i=Ts(o);if(!i.length)return a.info("No clickable candidates found via CDP snapshot"),0;const c=i.map(l=>l.backendNodeId);let u=[];try{const l=await e.send("DOM.pushNodesByBackendIdsToFrontend",{backendNodeIds:c});u=(l==null?void 0:l.nodeIds)||[]}catch(l){return a.debug("Failed to push backend nodes to frontend",{error:l}),0}const h=new Map;for(let l=0;l<c.length&&l<u.length;l++){const p=u[l];p>=0&&h.set(c[l],p)}a.debug("All clickable candidates",{total:i.length,candidates:i.map(l=>({backendNodeId:l.backendNodeId,nodeId:h.get(l.backendNodeId),tagName:l.tagName,id:l.id,paintOrder:l.paintOrder,position:{x:l.xPosition,y:l.yPosition}}))});let d=0;for(const l of i){const p=h.get(l.backendNodeId);if(p===void 0){a.debug(`No frontend node id mapped for backend node ${l.backendNodeId}`);continue}await Ms(e,p),d++}return a.info(`Marked ${d} clickable elements via CDP snapshot`),d})}const xs=500,Rs=8e3;class Bs{async runAction(e,t,s={}){try{await Tt(e)&&a.info("Reset tab zoom to 100%",{tabId:e});const o=await this.executeAction(e,t);if(s.captureArtifacts??(t.type!=="wait"&&o.status==="success"))try{await this.ensureContentScriptReady(e,10);const c=t.type==="browser_navigate"?5e3:3e3,u=s.restoreMask??!0,h=await this.collectArtifacts(e,c,u);h&&(o.artifacts=h)}catch(c){const u=c instanceof Error?c.message:String(c);a.error("Failed to collect artifacts after action execution",{actionType:t.type,error:u}),t.type==="browser_view"&&(o.status="error",o.error=`Artifacts collection failed: ${u}`)}return o}catch(n){const o=n instanceof Error?n.message:String(n);return a.error("Action execution failed",{actionType:t.type,reason:o}),{status:"error",error:o}}}async executeAction(e,t){switch(t.type){case"browser_navigate":return await Ct(e,{url:t.url,active:!1}),await this.ensureContentScriptReady(e),{status:"success",message:`Navigated to URL: ${t.url}`};case"browser_press_key":return await this.withCdpUnblock(e,t,async()=>{const s=await Qt(e,t.key);return s.success?{status:"success",message:`Pressed key via CDP: ${t.key}`,data:{key:t.key}}:{status:"error",error:`Press key failed: ${s.error}`,data:{key:t.key,cdpError:s.error}}});case"browser_input":case"browser_scroll":case"browser_click":case"browser_find_keyword":return await this.withCdpUnblock(e,t,async()=>{const s=await this.executeInPage(e,t);return s.ok?{status:"success",message:s.message,data:s.data}:{status:"error",error:s.error||"Action execution failed"}});case"wait":return await this.delay(t.ms),{status:"success",message:`Waited ${t.ms}ms`};case"browser_view":return{status:"success",message:"Page view captured"};default:{const s=t;throw new Error(`Unsupported action ${s.type}`)}}}async executeInPage(e,t){return E(e,{source:"background",type:"page/execute-action",action:t})}async collectArtifacts(e,t,s=!0){await this.ensureContentScriptReady(e);const n=async o=>{let i=null,c=null,u="",h=[];try{await E(e,{source:"background",type:"page/toggle-page-effect",state:"idle"});try{await As(e)}catch(m){a.warn("Failed to mark clickable elements via CDP, falling back to JS scan",{error:m instanceof Error?m.message:String(m)})}const d=await E(e,{source:"background",type:"page/prepare-artifacts",maxTimeout:t});if(a.debug("Collected artifacts",d),!d.ok)throw new Error(d.error||"Failed to prepare artifacts");u=d.markdownContent??"",h=d.elementRects??[],c=await this.captureScreenshot(o,"clean"),s&&E(e,{source:"background",type:"page/toggle-page-effect",state:"ongoing"}),c&&(i=await this.getHighlightedScreenshot(c,h)),(!i||!c)&&a.warn("Missing captured screenshots, continuing with available data",{hasHighlighted:!!i,hasClean:!!c}),u=Gt(u,Rs,!1,!0);const l={};i&&(l.highlighted={width:i.width,height:i.height,originalWidth:i.originalWidth,originalHeight:i.originalHeight,scaleX:i.scaleX,scaleY:i.scaleY}),c&&(l.clean={width:c.width,height:c.height,originalWidth:c.originalWidth,originalHeight:c.originalHeight,scaleX:c.scaleX,scaleY:c.scaleY});const p=[i,c].filter(m=>m!==null);return{textContent:u,markdownContent:u,screenshots:p,elements:d.elements,metadata:{highlightCount:d.highlightCount??void 0,screenshotScales:l}}}finally{s&&E(e,{source:"background",type:"page/toggle-page-effect",state:"ongoing"})}};return Me(e,async(o,i)=>n({session:o,viewport:i}))}async getHighlightedScreenshot(e,t){if(!t||t.length===0)return e;try{return{id:"highlighted",label:"highlighted",fileName:"highlighted.png",dataUrl:await zt(e.dataUrl,t,{scaleX:e.scaleX,scaleY:e.scaleY}),width:e.width,height:e.height,originalWidth:e.originalWidth,originalHeight:e.originalHeight,scaleX:e.scaleX,scaleY:e.scaleY}}catch(s){const n=s instanceof Error?s.message:String(s);return a.warn("Failed to generate highlighted screenshot via getHighlightedSnapshot",{reason:n}),null}}async captureScreenshot(e,t){const s=await fs(e.session,e.viewport,{format:"png"});return{id:t,label:t,fileName:`${t}.png`,dataUrl:s.dataUrl,width:s.width,height:s.height,originalWidth:s.originalWidth,originalHeight:s.originalHeight,scaleX:s.scaleX,scaleY:s.scaleY}}async ensureContentScriptReady(e,t=10){await this.wakeUpTab(e),await this.delay(xs);let s;for(let n=0;n<t;n+=1){let o=!1;try{const i=await E(e,{source:"background",type:"page/check-ready"});if(!i.ok)throw new Error("Check-ready response indicated failure");if(i.ready){if((i.sinceLoadMs??0)>2e3)return;n>=5?await this.delay(500):n>=2&&await this.delay(200);return}o=!0}catch(i){if(s=i,n===t-1)throw a.error(`Content script failed to become ready after ${t} attempts for tab ${e}`,{lastError:s instanceof Error?s.message:s}),i;o=!0}if(o){const i=n<5?200:n<15?400:800;await this.delay(i)}}}async delay(e){e<=0||await new Promise(t=>{globalThis.setTimeout(t,e)})}async wakeUpTab(e){try{await chrome.scripting.executeScript({target:{tabId:e},func:()=>{document.body}})}catch(t){a.warn(`Failed to wake up tab ${e} via scripting API`,{error:t instanceof Error?t.message:String(t)})}}async withCdpUnblock(e,t,s){const n=["browser_press_key","browser_scroll","browser_input"].includes(t.type);n&&await E(e,{source:"background",type:"page/event-unblock"});try{return await s()}finally{n&&await E(e,{source:"background",type:"page/event-block"})}}}class Ns{constructor(){g(this,"cleanupWatcher",null);g(this,"debounceTimers",new Map)}async initialize(){try{const e=q.getBrowserSettings();(!e||!e.browserName)&&await q.setBrowserSettings(Bt);const t=await this.getManusAppCookies();if(a.info("Manus app cookies obtained",{cookies:t}),t.token){const s=this.normalizeValue(t.token);await J.setToken(s)}else a.info("No token found in cookies");if(t.devBranch){const s=this.normalizeValue(t.devBranch);await me.setDevBranch(s)}else a.info("No devBranch found in cookies");return{token:this.normalizeValue(t.token),initialized:!0}}catch(e){const t=e instanceof Error?e.message:String(e);return a.error("Failed to initialize auth",{error:t}),{token:null,initialized:!1}}}startWatcher(){var o;if(!((o=chrome.cookies)!=null&&o.onChanged)){a.warn("chrome.cookies API unavailable; skip Manus cookies watcher");return}this.stopWatcher();const e=$.getEnvParams().webAppDomain;let t;try{t=new URL(e).hostname}catch(i){a.error("Failed to start Manus cookies watcher; invalid URL",{url:e,error:i instanceof Error?i.message:String(i)});return}const s=[{cookieName:"session_id",getCurrentValue:()=>J.getToken(),setValue:i=>J.setToken(i)}],n=i=>{const{cookie:c,removed:u}=i;if(!c)return;const h=c.domain.startsWith(".")?c.domain.slice(1):c.domain;if(!(t===h||t.endsWith(`.${h}`)))return;const l=s.find(p=>p.cookieName===c.name);l&&this.handleCookieChangeWithDebounce(c.name,u,c.value,l)};chrome.cookies.onChanged.addListener(n),a.info("Started watching Manus app cookies",{host:t,cookies:s.map(i=>i.cookieName)}),this.cleanupWatcher=()=>{chrome.cookies.onChanged.removeListener(n);for(const i of this.debounceTimers.values())clearTimeout(i);this.debounceTimers.clear(),a.info("Stopped watching Manus app cookies",{host:t,cookies:s.map(i=>i.cookieName)})}}stopWatcher(){this.cleanupWatcher&&(this.cleanupWatcher(),this.cleanupWatcher=null)}async getManusAppCookies(){const e=$.getEnvParams().webAppDomain,[t,s]=await Promise.all([new Promise((n,o)=>{chrome.cookies.get({url:e,name:"session_id"},i=>{if(chrome.runtime.lastError){o(new Error(chrome.runtime.lastError.message));return}n(i)})}),new Promise((n,o)=>{chrome.cookies.get({url:e,name:"devBranch"},i=>{if(chrome.runtime.lastError){o(new Error(chrome.runtime.lastError.message));return}n(i)})})]);return{token:(t==null?void 0:t.value)??null,devBranch:(s==null?void 0:s.value)??null}}handleCookieChangeWithDebounce(e,t,s,n){const o=this.debounceTimers.get(e);o&&clearTimeout(o);const i=t?null:this.normalizeValue(s);a.debug(`Manus ${e} cookie change detected (debouncing)`,{removed:t,nextValue:i});const c=setTimeout(()=>{const u=n.getCurrentValue();i!==u&&(a.info(`Manus ${e} cookie changed (debounced)`,{removed:t,nextValue:i,currentValue:u}),n.setValue(i).catch(h=>{a.error(`Failed to sync ${e} from cookie change`,{removed:t,error:h instanceof Error?h.message:String(h)})})),this.debounceTimers.delete(e)},500);this.debounceTimers.set(e,c)}normalizeValue(e){if(typeof e!="string")return null;const t=e.trim();return t.length>0?t:null}}const oe=new Ns,Ls=1e4;class Ps{constructor(){g(this,"suspendListener",null);g(this,"pollTimer",null)}registerManusAppPolling(){this.unregisterListeners(),this.notifyManusAppTabs(),this.pollTimer=setInterval(()=>{this.notifyManusAppTabs()},Ls),this.suspendListener=()=>this.unregisterListeners(),chrome.runtime.onSuspend.addListener(this.suspendListener)}unregisterListeners(){this.suspendListener&&(chrome.runtime.onSuspend.removeListener(this.suspendListener),this.suspendListener=null),this.pollTimer&&(clearInterval(this.pollTimer),this.pollTimer=null)}async notifyManusAppTabs(){try{const t=(await chrome.tabs.query({})).filter(o=>{if(!o.url||!o.id)return!1;try{return Lt(new URL(o.url).origin)}catch{return!1}});if(t.length===0)return;const[s,n]=await Promise.all([j(),Promise.resolve(q.getBrowserSettings())]);for(const o of t)try{await chrome.scripting.executeScript({target:{tabId:o.id},func:i=>{window.postMessage({source:"my-browser",type:"extension/ready",data:i},"*")},args:[{clientId:s,browserSettings:n,eventTimestamp:Date.now()}]})}catch{}}catch(e){a.warn("ManusAppManager: Failed to notify tabs",e)}}}class Os{constructor(e){g(this,"sessions",new Map);g(this,"tabIdToSession",new Map);g(this,"pendingSessions",new Map);g(this,"tabGroupManager");g(this,"onDisposeSession");g(this,"onStopSession");g(this,"onResumeSession");this.tabGroupManager=e.tabGroupManager,this.onDisposeSession=e.onDisposeSession,this.onStopSession=e.onStopSession,this.onResumeSession=e.onResumeSession,chrome.tabs.onRemoved.addListener(t=>{const s=this.tabIdToSession.get(t);s&&(a.warn("Pinned session tab removed, disposing session",{sessionId:s,tabId:t}),this.cleanupSession(s,"tab_removed"))})}async enqueue(e,t){a.warn("[SessionManager] ðŸ“ Enqueue task",{sessionId:e});const s=await this.ensureSession(e);a.warn("[SessionManager] âœ“ Session ensured",{sessionId:e,tabId:s.tabId,disposed:s.disposed,status:s.status});const n=s.queue.then(async()=>{if(s.disposed)throw new Error(`Session ${e} already disposed`);return a.warn("[SessionManager] ðŸš€ Executing enqueued task",{sessionId:e,tabId:s.tabId}),t(s.tabId)});return s.queue=n.catch(o=>{a.error("[SessionManager] âŒ Session task failed",{sessionId:e,error:o instanceof Error?o.message:o})}).then(()=>{}),n}async ensureSession(e){a.warn("[SessionManager] ðŸ” Ensuring session",{sessionId:e,existingCount:this.sessions.size,pendingCount:this.pendingSessions.size});const t=this.sessions.get(e);if(t){a.warn("[SessionManager] ðŸ“Œ Found existing session",{sessionId:e,tabId:t.tabId,disposed:t.disposed,status:t.status});try{return await U(t.tabId),a.warn("[SessionManager] âœ“ Existing session tab is valid",{sessionId:e,tabId:t.tabId}),t}catch(o){a.warn("[SessionManager] âš ï¸ Session tab missing, recreating",{sessionId:e,tabId:t.tabId,error:o instanceof Error?o.message:o}),this.cleanupSession(e,"tab_missing")}}const s=this.pendingSessions.get(e);if(s)return a.warn("[SessionManager] â³ Waiting for concurrent session creation",{sessionId:e}),await s;a.warn("[SessionManager] ðŸ†• Starting new session creation",{sessionId:e});const n=this.createSession(e);this.pendingSessions.set(e,n);try{const o=await n;return a.warn("[SessionManager] âœ… Session created successfully",{sessionId:e,tabId:o.tabId}),o}catch(o){throw a.error("[SessionManager] ðŸ’¥ Session creation failed",{sessionId:e,error:o instanceof Error?o.message:o}),o}finally{this.pendingSessions.delete(e),a.warn("[SessionManager] ðŸ§¹ Removed session from pending",{sessionId:e})}}async createSession(e){a.warn("[SessionManager] ðŸ› ï¸ Creating session",{sessionId:e});const t=await this.tabGroupManager.ensureTabForSession(e,"about:blank");await this.tabGroupManager.setTaskState(e,"doing");const s={tabId:t,queue:Promise.resolve(),disposed:!1,status:"stopped"};return this.sessions.set(e,s),this.tabIdToSession.set(t,e),s}getSession(e){let t;if(a.debug("SessionManager getSession this.sessions:",this.sessions),"sessionId"in e)t=e.sessionId;else if("tabId"in e&&(t=this.tabIdToSession.get(e.tabId),!t)){a.debug("No session found for tabId",{tabId:e.tabId});return}if(!t){a.debug("No session found for",e);return}const s=this.sessions.get(t);if(!s)return;const{queue:n,...o}=s;return{sessionId:t,...o}}async updateSessionStatus(e,t){try{a.warn("[SessionManager] ðŸ”„ Updating session status",{sessionId:e,options:t});const s=this.sessions.get(e);if(!s)return a.warn("Cannot update status: session not found",{sessionId:e}),!1;s.status=t.status;let n,o;switch(t.status){case"running":n="doing",o="ongoing";break;case"completed":n="completed",o="idle";break;case"stopped":case"error":n="waiting",o="idle";break;case"takeover":n="waiting",o="takeover";break}return await this.tabGroupManager.setTaskState(e,n,t.taskName!==void 0?{taskName:t.taskName}:{}),await E(s.tabId,{source:"background",type:"page/toggle-page-effect",state:o}).catch(i=>{a.warn("Failed to update page effect state",{sessionId:e,error:i instanceof Error?i.message:i})}),!0}catch(s){return a.error("Failed to update session status",{sessionId:e,options:t,error:s instanceof Error?s.message:s}),!1}}async unauthorizeSession(e){var t;try{const s=this.sessions.get(e);if(!s)return;await((t=this.onStopSession)==null?void 0:t.call(this,e)),await this.tabGroupManager.setTaskState(e,"waiting"),await E(s.tabId,{source:"background",type:"page/toggle-page-effect",state:"idle"}),this.cleanupSession(e,"user_stop_session")}catch(s){a.error("Failed to unauthorize session",{sessionId:e,error:s instanceof Error?s.message:s})}}async stopSession(e){var t;try{const s=this.sessions.get(e);if(!s)return;await((t=this.onStopSession)==null?void 0:t.call(this,e)),await this.tabGroupManager.setTaskState(e,"waiting"),await E(s.tabId,{source:"background",type:"page/toggle-page-effect",state:"takeover"})}catch(s){a.error("Failed to stop session",{sessionId:e,error:s instanceof Error?s.message:s})}}async resumeSession(e,t){var o;const s=this.sessions.get(e);if(!s)return;const n=t!=null&&t.trim()?t:"Take over summary not provided.";try{await((o=this.onResumeSession)==null?void 0:o.call(this,e,n)),await this.tabGroupManager.setTaskState(e,"doing"),await E(s.tabId,{source:"background",type:"page/toggle-page-effect",state:"ongoing"})}catch(i){a.error("Failed to resume session",{sessionId:e,error:i instanceof Error?i.message:i})}}async disposeSession(e,t){this.cleanupSession(e,t)}listSessions(){return Array.from(this.sessions.keys())}cleanupSession(e,t){const s=this.sessions.get(e);if(!s)return;if(et(s.tabId).catch(o=>{a.warn("Failed to cleanup CDP session during session disposal",{sessionId:e,tabId:s.tabId,error:o instanceof Error?o.message:o})}),this.tabGroupManager.cleanupSession(e).catch(o=>{a.warn("Failed to cleanup tab group during session disposal",{sessionId:e,error:o instanceof Error?o.message:o})}),t==="tab_removed"||t==="tab_missing"?(this.sessions.delete(e),this.tabIdToSession.delete(s.tabId)):a.info("Keeping session entry despite cleanup",{sessionId:e,event:t,currentStatus:s.status}),this.onDisposeSession)try{this.onDisposeSession(e,t)}catch(o){a.error("onSessionDisposed callback threw",{sessionId:e,error:o instanceof Error?o.message:o})}}}const ke=["ðŸ‘†","ðŸ–ï¸","ðŸ‘‹","ðŸ‘","ðŸ––","ðŸ«°","âœŒ","ðŸ¤š","ðŸ¤Ÿ","ðŸ‘‰","ðŸ¤ž","ðŸ‘‡","â˜","ðŸ¤™","ðŸ‘ˆ","âœŠ","ðŸ¤˜"],tt="âœ…",st="âŒ›ï¸",Ds=1e3,Is="Manus Task",Fs=[...ke,tt,st],We=new RegExp(`^(${Fs.map(r=>r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")).join("|")})\\s+`);class Us{constructor(){g(this,"sessionGroups",new Map);g(this,"supportsTabGroups",null);a.info("TabManager initialized");const e=this.isTabGroupsSupported();a.info("TabGroups support detected",{supportsTabGroups:e}),chrome.tabs.onRemoved.addListener(this.handleTabRemoved.bind(this)),this.setupCleanupListeners()}handleTabRemoved(e){if(!this.isTabGroupsSupported()){for(const[t,s]of this.sessionGroups.entries())s.tabId===e&&(a.warn("Session tab removed, cleaning up",{sessionId:t,tabId:e}),this.cleanupSession(t));return}for(const[t,s]of this.sessionGroups.entries())chrome.tabs.query({groupId:s.groupId},n=>{n.length===0&&(a.warn("All tabs in session group removed, cleaning up",{sessionId:t}),this.cleanupSession(t))})}isTabGroupsSupported(){if(this.supportsTabGroups!==null)return this.supportsTabGroups;const e=typeof chrome.tabs<"u"&&typeof chrome.tabs.group=="function"&&typeof chrome.tabGroups<"u";return this.supportsTabGroups=e,e}setupCleanupListeners(){var e,t;try{(t=(e=chrome.tabGroups)==null?void 0:e.onRemoved)==null||t.addListener(s=>{for(const[n,o]of this.sessionGroups.entries())o.groupId===s.id&&(a.warn("Tab group removed, cleaning up session",{sessionId:n,groupId:s.id}),this.cleanupSession(n))})}catch{}chrome.windows.onRemoved.addListener(s=>{a.debug("Window removed event received",{removedWindowId:s});for(const[n,o]of this.sessionGroups.entries())o.windowId===s&&(a.warn("Session window removed, cleaning up session",{sessionId:n,windowId:s}),this.cleanupSession(n))})}async getTabForSession(e){var n;const t=this.sessionGroups.get(e);if(!t)throw new Error(`Session not found: ${e}`);if(!this.isTabGroupsSupported())try{return await U(t.tabId),t.tabId}catch(o){throw new Error(`Tab for session ${e} is no longer available: ${o instanceof Error?o.message:String(o)}`)}try{const o=await chrome.tabs.query({groupId:t.groupId});if(o.length>0&&((n=o[0])==null?void 0:n.id)!==void 0)return await U(o[0].id),o[0].id}catch(o){throw new Error(`Tab for session ${e} is no longer available: ${o instanceof Error?o.message:String(o)}`)}throw new Error(`No tabs found in group for session: ${e}`)}async ensureTabForSession(e,t){var o;const s=this.isTabGroupsSupported(),n=this.sessionGroups.get(e);if(n)try{if(!s)return await U(n.tabId),n.tabId;const i=await chrome.tabs.query({groupId:n.groupId,windowId:n.windowId});if(i.length>0&&((o=i[0])==null?void 0:o.id)!==void 0)return await U(i[0].id),i[0].id}catch(i){a.warn("Session tab or group missing, recreating",{sessionId:e,error:i instanceof Error?i.message:i}),this.cleanupSession(e)}if(!s)return await this.createUngroupedTab(e,t);try{const{tabId:i,groupId:c,windowId:u}=await this.createGroupedTab({url:t,title:e,color:"grey",pinned:!1,active:!1,collapsed:!1});return this.sessionGroups.set(e,{tabId:i,groupId:c,windowId:u,sessionId:e,animationInterval:null}),a.info("Created tab and group for session",{sessionId:e,tabId:i,groupId:c,windowId:u}),i}catch(i){const c=i instanceof Error?i.message:String(i);if(c.includes("Grouping is not supported by tabs"))return a.warn("TabGroups not supported, switching to simple tab mode",{sessionId:e,error:c}),this.supportsTabGroups=!1,await this.createUngroupedTab(e,t);throw a.error("Failed to create grouped tab",{sessionId:e,error:c}),i}}async setTaskState(e,t,s={}){const n=this.sessionGroups.get(e);if(!n){a.warn("Cannot update group task state: session not found",{sessionId:e,state:t});return}typeof s.taskName=="string"&&s.taskName.trim().length>0&&(n.taskName=s.taskName.trim());const o=n.taskName||await this.getTaskLabel(n)||Is;switch(t){case"doing":{this.startTaskOngoingAnimation(n,o);break}case"completed":{this.stopTaskOngoingAnimation(n),await this.updateTitle(n,`${tt} ${o}`);break}case"waiting":{this.stopTaskOngoingAnimation(n),await this.updateTitle(n,`${st} ${o}`);break}default:{this.stopTaskOngoingAnimation(n),await this.updateTitle(n,o);break}}}async cleanupSession(e){const t=this.sessionGroups.get(e);t&&(this.stopTaskOngoingAnimation(t),this.sessionGroups.delete(e))}async updateTitle(e,t){if(this.isTabGroupsSupported())try{await $e(e.groupId,{title:t})}catch(s){a.warn("Failed to update tab group title",{sessionId:e.sessionId,groupId:e.groupId,error:s instanceof Error?s.message:s})}}async getTaskLabel(e){var t,s;if(!this.isTabGroupsSupported())try{const n=await U(e.tabId);return((t=n==null?void 0:n.title)==null?void 0:t.replace(We,"").trim())||null}catch{return null}try{const n=await Mt(e.groupId);return((s=n==null?void 0:n.title)==null?void 0:s.replace(We,"").trim())||null}catch{return null}}async createUngroupedTab(e,t){const s=await qe({url:t,pinned:!1,active:!1});if(!s.id)throw new Error("Failed to create tab");try{const n=await chrome.tabs.query({pinned:!0});await At(s.id,{index:n.length})}catch(n){a.warn("Failed to move tab to leftmost position",{sessionId:e,tabId:s.id,error:n instanceof Error?n.message:String(n)})}return this.sessionGroups.set(e,{tabId:s.id,windowId:s.windowId,sessionId:e,animationInterval:null}),a.info("Created tab for session (non-tabGroup mode)",{sessionId:e,tabId:s.id,windowId:s.windowId}),s.id}async createGroupedTab(e){const{url:t,title:s,color:n="grey",pinned:o=!1,active:i=!1,collapsed:c=!1,windowId:u}=e;let h,d;try{const l=await qe({url:t,pinned:o,active:i});h=l.id,d=l.windowId;const p=await xt({createProperties:{windowId:u},tabIds:[h]});await $e(p,{title:s,collapsed:c,color:n});const m=await chrome.tabs.query({pinned:!0});return await Rt(p,{index:m.length}),{tabId:h,groupId:p,windowId:d}}catch(l){if(h!==void 0)try{await chrome.tabs.remove(h)}catch(p){a.error("Failed to cleanup orphaned tab",{tabId:h,error:p instanceof Error?p.message:String(p)})}throw l}}startTaskOngoingAnimation(e,t){this.stopTaskOngoingAnimation(e);let s=0;const n=async()=>{const o=ke[s];await this.updateTitle(e,`${o} ${t}`),s=(s+1)%ke.length};n(),e.animationInterval=setInterval(()=>{n()},Ds)}stopTaskOngoingAnimation(e){e.animationInterval&&(clearInterval(e.animationInterval),e.animationInterval=null)}}class $s{constructor(e){this.sessionManager=e}async handle(e,t){var i;if(!Pt(e))throw new Error("Invalid message type for ContentMessageHandler");const s=(i=t.tab)==null?void 0:i.id;if(!s)return a.warn("No tabId in message sender"),{ok:!1,error:"No tabId found"};if(e.type==="content/heartbeat")return this.handleHeartbeat(s);const n=this.sessionManager.getSession({tabId:s});if(!n)return a.warn("No session found for tabId",{tabId:s}),{ok:!1,error:"Session not found"};const o=n.sessionId;switch(e.type){case"extension/stop-task":return this.handleStopTask(o);case"extension/unauthorize-task":return this.handleUnauthorizeTask(o);case"extension/resume-task":return this.handleResumeTask(o,e.summary);default:throw new Error("Unhandled message type")}}async handleStopTask(e){try{return await this.sessionManager.stopSession(e),{ok:!0}}catch(t){const s=t instanceof Error?t.message:String(t);return a.error("Failed to stop task",{sessionId:e,errorMsg:s}),{ok:!1,error:s}}}async handleUnauthorizeTask(e){try{return await this.sessionManager.unauthorizeSession(e),{ok:!0}}catch(t){const s=t instanceof Error?t.message:String(t);return a.error("Failed to terminate task",{sessionId:e,errorMsg:s}),{ok:!1,error:s}}}async handleResumeTask(e,t){try{return await this.sessionManager.resumeSession(e,t),{ok:!0}}catch(s){const n=s instanceof Error?s.message:String(s);return a.error("Failed to resume task",{sessionId:e,errorMsg:n}),{ok:!1,error:n}}}handleHeartbeat(e){return{ok:!0}}}class qs{constructor(e){g(this,"allowedOrigins");this.tabManager=e,this.allowedOrigins=["https://manus.im","https://vida.butterfly-effect.dev","http://localhost","http://127.0.0.1"],a.debug("ManusAppHandler initialized",{allowedOrigins:this.allowedOrigins})}async handle(e,t){if(!Ot(e))throw new Error("Invalid message type for ManusAppHandler");const s=t.url;if(!s)return a.warn("Message rejected: no sender URL"),this.buildErrorResponse(e.requestId,"No sender URL");let n;try{n=new URL(s).origin}catch{return a.warn("Message rejected: invalid sender URL",{senderUrl:s}),this.buildErrorResponse(e.requestId,"Invalid sender URL")}if(!this.allowedOrigins.some(i=>i==="http://localhost"||i==="http://127.0.0.1"?n.startsWith("http://localhost")||n.startsWith("http://127.0.0.1"):n===i))return a.warn("Message rejected: origin not allowed",{origin:n,allowedOrigins:this.allowedOrigins}),this.buildErrorResponse(e.requestId,"Origin not allowed");switch(e.type){case"my-browser/ping":return this.handlePing(e.requestId);case"my-browser/switch-to-tab":return this.handleSwitchToTab(e.sessionId,e.requestId);case"my-browser/set-browser-settings":return this.handleSetBrowserSettings(e.browserSettings,e.requestId);default:return a.error("Unsupported message type from Manus App"),this.buildErrorResponse("unknown","Unsupported message type")}}async handlePing(e){const t=q.getBrowserSettings();return this.buildSuccessResponse(e,{browserSettings:t})}async handleSwitchToTab(e,t){try{const s=await this.tabManager.getTabForSession(e);await chrome.tabs.update(s,{active:!0});const n=await chrome.tabs.get(s);return n.windowId&&await chrome.windows.update(n.windowId,{focused:!0}),this.buildSuccessResponse(t)}catch(s){const n=s instanceof Error?s.message:String(s);return a.error("Failed to switch to session tab",{sessionId:e,error:n}),this.buildErrorResponse(t,`Failed to switch tab: ${n}`)}}async handleSetBrowserSettings(e,t){try{return await q.setBrowserSettings(e),this.buildSuccessResponse(t,{browserSettings:e})}catch(s){const n=s instanceof Error?s.message:String(s);return a.error("Failed to update browser settings",{error:n}),this.buildErrorResponse(t,`Failed to update browser settings: ${n}`)}}async buildSuccessResponse(e,t){const s=await j();return{ok:!0,source:"my-browser",requestId:e,data:{clientId:s,...t}}}async buildErrorResponse(e,t){const s=await j();return{ok:!1,source:"my-browser",requestId:e,error:t,data:{clientId:s}}}}class Hs{constructor(e,t){this.sessionManager=e,this.broadcastTabStatus=t}async handle(e){if(!Dt(e))throw new Error("Invalid message type for PopupMessageHandler");switch(e.type){case"popup/get-tab-status":return this.handleGetTabStatus();case"extension/unauthorize-task":return this.handleUnauthorizeTask(e.sessionId);default:throw new Error("Unhandled message type")}}async handleGetTabStatus(){var t;const e=await chrome.tabs.query({active:!0,currentWindow:!0});return(t=e[0])!=null&&t.id?this.broadcastTabStatus(e[0].id):a.warn("No active tab found for popup status request"),{ok:!0}}async handleUnauthorizeTask(e){try{return await this.sessionManager.unauthorizeSession(e),{ok:!0}}catch(t){const s=t instanceof Error?t.message:String(t);return a.error("Failed to unauthorize task",{sessionId:e,error:s}),{ok:!1,error:s}}}}function Vs(r){for(var e=-1,t=r==null?0:r.length,s=0,n=[];++e<t;){var o=r[e];o&&(n[s++]=o)}return n}class Ws{constructor(e,t,s){this.getSocketBridge=e,this.getMockSocketBridge=t,this.actionExecutor=s}async handle(e){if(!It(e))throw new Error("Invalid message type for SidepanelHandler");switch(e.type){case"automation/get-scenarios":return this.handleGetScenarios();case"automation/run-scenario":return a.warn("automation/run-scenario not implemented yet"),{ok:!1,error:"Not implemented"};case"automation/stop-scenario":return a.warn("automation/stop-scenario not implemented yet"),{ok:!1,error:"Not implemented"};case"automation/run-mock-scenario":return this.handleRunMockScenario(e.scenarioId);case"automation/stop-mock-scenario":return this.handleStopMockScenario(e.scenarioId);case"automation/activate":return this.handleAutomationActivate();case"automation/trigger-browser-action":return this.handleBrowserActionTrigger(e.tabId,e.action,e.captureArtifacts);default:throw new Error("Unhandled message type")}}handleGetScenarios(){return{ok:!0,scenarios:bt.map(t=>({id:t.id,name:t.name,description:t.description,stepCount:t.steps.length,steps:t.steps.map((s,n)=>({stepNumber:n+1,description:zs(s),payload:s}))}))}}async handleRunMockScenario(e){const t=this.getMockSocketBridge();if(!t)return a.error("MockSocketBridge not initialized"),{ok:!1,error:"MockSocketBridge not initialized"};try{return{ok:!0,runId:await t.runMockScenario(e)}}catch(s){const n=s instanceof Error?s.message:String(s);return a.error("Failed to run mock scenario",{scenarioId:e,reason:n}),{ok:!1,error:n}}}async handleStopMockScenario(e){const t=this.getMockSocketBridge();if(!t)return a.error("MockSocketBridge not initialized"),{ok:!1,error:"MockSocketBridge not initialized"};try{return await t.stopMockScenario(e),{ok:!0}}catch(s){const n=s instanceof Error?s.message:String(s);return a.error("Failed to stop mock scenario",{scenarioId:e,reason:n}),{ok:!1,error:n}}}async handleAutomationActivate(){const{token:e}=await oe.initialize();if(!e)return a.error("User token not found"),{ok:!1,sessionId:null,error:"session_id cookie not found"};const t=this.getSocketBridge();return t==null||t.emitExtensionActivation(),{ok:!0,sessionId:e}}async handleBrowserActionTrigger(e,t,s){const n=Date.now(),o=`sidepanel-${t.type}-${n}`,i=`sidepanel-trigger-${n}`;try{a.info("Executing browser action from sidepanel",{tabId:e,actionType:t.type,captureArtifacts:s,runId:o});const c=await this.actionExecutor.runAction(e,t,{captureArtifacts:s,restoreMask:!1});return this.emitProgressEvent(o,i,t,c),{ok:c.status==="success",message:c.message,error:c.error,data:c.data,artifacts:c.artifacts}}catch(c){const u=c instanceof Error?c.message:String(c);return a.error("Failed to execute browser action from sidepanel",{tabId:e,actionType:t.type,reason:u,runId:o}),this.emitProgressEvent(o,i,t,{status:"error",error:u}),{ok:!1,error:u}}}emitProgressEvent(e,t,s,n){const o=n.status==="error",i={runId:e,scenarioId:t,status:o?"error":"success",action:s,message:n.message,error:n.error,artifacts:n.artifacts};Q({source:"background",type:"automation/progress",result:i}).catch(c=>{const u=c instanceof Error?c.message:String(c);a.warn("Failed to emit progress event",u)})}}function zs(r){if(r.type==="session_status")return Vs([`Session status: ${r.status}`,r.sessionTitle&&`"${r.sessionTitle}"`,r.error&&`(error: ${r.error})`]).join(" ");const e=r.action;if(e.browser_navigate)return`Navigate to ${e.browser_navigate.url}`;if(e.browser_view)return"View page";if(e.browser_press_key)return`Press key: ${e.browser_press_key.key}`;if(e.browser_scroll_down)return e.browser_scroll_down.to_bottom?"Scroll to bottom":"Scroll down";if(e.browser_scroll_up)return e.browser_scroll_up.to_top?"Scroll to top":"Scroll up";if(e.browser_scroll_left)return e.browser_scroll_left.to_end?"Scroll to start":"Scroll left";if(e.browser_scroll_right)return e.browser_scroll_right.to_end?"Scroll to end":"Scroll right";if(e.browser_find_keyword)return`Find: "${e.browser_find_keyword.keyword}"`;if(e.browser_click){const{index:t,coordinate_x:s,coordinate_y:n}=e.browser_click;return s!=null&&n!=null?`Click (${s}, ${n})`:t!=null?`Click [${t}]`:"Click"}if(e.browser_input){const{index:t,coordinate_x:s,coordinate_y:n,text:o,press_enter:i}=e.browser_input;return`Input${s!=null&&n!=null?` (${s}, ${n})`:t!=null?` [${t}]`:""}: "${o}"${i?" âŽ":""}`}return"Unknown"}async function ze(r,e){const t=Gs(e.dataUrl),s=await globalThis.fetch(r,{method:"PUT",body:t,headers:{"Content-Type":"image/png"}});let n="";try{n=await s.clone().text()}catch{}if(s.status!==200)throw a.error("[uploadScreenshot] ä¸Šä¼ å¤±è´¥",{label:e.label,status:s.status,statusText:s.statusText,body:n}),new Error(`Upload failed with status ${s.status}: ${n||s.statusText}`);const o=s.headers.get("ETag");if(!o)throw a.error("[uploadScreenshot] ä¸Šä¼ å¤±è´¥ï¼šå“åº”ç¼ºå°‘ ETag",{label:e.label,status:s.status}),new Error("Upload failed: Missing ETag in response (S3 upload may not have completed)");a.info("[uploadScreenshot] ä¸Šä¼ æˆåŠŸ",{label:e.label,status:s.status,etag:o})}function Gs(r){const e=/^data:(.+);base64,(.*)$/.exec(r);if(!e)throw a.error("[dataUrlToUint8Array] æ— æ•ˆçš„ data URL æ ¼å¼",{dataUrlPrefix:r.substring(0,50)}),new Error("Invalid data URL provided");const t=e[2]??"",s=globalThis.atob(t),n=s.length,o=new Uint8Array(n);for(let i=0;i<n;i+=1)o[i]=s.charCodeAt(i);return o}async function Ks(r,e,t){const s={screenshot_uploaded:!1,clean_screenshot_uploaded:!1};if(!(r!=null&&r.screenshots))return s;const{screenshots:n}=r,o=n.find(u=>u.label==="highlighted"),i=n.find(u=>u.label==="clean"),c=[];return o&&e&&c.push(ze(e,o).then(()=>{s.screenshot_uploaded=!0,a.info("[handleScreenshotUploads] Highlighted æˆªå›¾ä¸Šä¼ æˆåŠŸ")}).catch(u=>{a.error("[handleScreenshotUploads] Highlighted æˆªå›¾ä¸Šä¼ å¤±è´¥",{type:"highlighted",screenshotPresignedUrl:e,error:u instanceof Error?u.message:String(u),stack:u instanceof Error?u.stack:void 0})})),i&&t&&c.push(ze(t,i).then(()=>{s.clean_screenshot_uploaded=!0,a.info("[handleScreenshotUploads] Clean æˆªå›¾ä¸Šä¼ æˆåŠŸ")}).catch(u=>{a.error("[handleScreenshotUploads] Clean æˆªå›¾ä¸Šä¼ å¤±è´¥",{type:"clean",cleanScreenshotPresignedUrl:t,error:u instanceof Error?u.message:String(u),stack:u instanceof Error?u.stack:void 0})})),await Promise.all(c),s}const L=Object.create(null);L.open="0";L.close="1";L.ping="2";L.pong="3";L.message="4";L.upgrade="5";L.noop="6";const ie=Object.create(null);Object.keys(L).forEach(r=>{ie[L[r]]=r});const be={type:"error",data:"parser error"},rt=typeof Blob=="function"||typeof Blob<"u"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",nt=typeof ArrayBuffer=="function",ot=r=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(r):r&&r.buffer instanceof ArrayBuffer,Ae=({type:r,data:e},t,s)=>rt&&e instanceof Blob?t?s(e):Ge(e,s):nt&&(e instanceof ArrayBuffer||ot(e))?t?s(e):Ge(new Blob([e]),s):s(L[r]+(e||"")),Ge=(r,e)=>{const t=new FileReader;return t.onload=function(){const s=t.result.split(",")[1];e("b"+(s||""))},t.readAsDataURL(r)};function Ke(r){return r instanceof Uint8Array?r:r instanceof ArrayBuffer?new Uint8Array(r):new Uint8Array(r.buffer,r.byteOffset,r.byteLength)}let pe;function Ys(r,e){if(rt&&r.data instanceof Blob)return r.data.arrayBuffer().then(Ke).then(e);if(nt&&(r.data instanceof ArrayBuffer||ot(r.data)))return e(Ke(r.data));Ae(r,!1,t=>{pe||(pe=new TextEncoder),e(pe.encode(t))})}const Ye="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",X=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(let r=0;r<Ye.length;r++)X[Ye.charCodeAt(r)]=r;const Xs=r=>{let e=r.length*.75,t=r.length,s,n=0,o,i,c,u;r[r.length-1]==="="&&(e--,r[r.length-2]==="="&&e--);const h=new ArrayBuffer(e),d=new Uint8Array(h);for(s=0;s<t;s+=4)o=X[r.charCodeAt(s)],i=X[r.charCodeAt(s+1)],c=X[r.charCodeAt(s+2)],u=X[r.charCodeAt(s+3)],d[n++]=o<<2|i>>4,d[n++]=(i&15)<<4|c>>2,d[n++]=(c&3)<<6|u&63;return h},Js=typeof ArrayBuffer=="function",xe=(r,e)=>{if(typeof r!="string")return{type:"message",data:it(r,e)};const t=r.charAt(0);return t==="b"?{type:"message",data:Qs(r.substring(1),e)}:ie[t]?r.length>1?{type:ie[t],data:r.substring(1)}:{type:ie[t]}:be},Qs=(r,e)=>{if(Js){const t=Xs(r);return it(t,e)}else return{base64:!0,data:r}},it=(r,e)=>{switch(e){case"blob":return r instanceof Blob?r:new Blob([r]);case"arraybuffer":default:return r instanceof ArrayBuffer?r:r.buffer}},at="",js=(r,e)=>{const t=r.length,s=new Array(t);let n=0;r.forEach((o,i)=>{Ae(o,!1,c=>{s[i]=c,++n===t&&e(s.join(at))})})},Zs=(r,e)=>{const t=r.split(at),s=[];for(let n=0;n<t.length;n++){const o=xe(t[n],e);if(s.push(o),o.type==="error")break}return s};function er(){return new TransformStream({transform(r,e){Ys(r,t=>{const s=t.length;let n;if(s<126)n=new Uint8Array(1),new DataView(n.buffer).setUint8(0,s);else if(s<65536){n=new Uint8Array(3);const o=new DataView(n.buffer);o.setUint8(0,126),o.setUint16(1,s)}else{n=new Uint8Array(9);const o=new DataView(n.buffer);o.setUint8(0,127),o.setBigUint64(1,BigInt(s))}r.data&&typeof r.data!="string"&&(n[0]|=128),e.enqueue(n),e.enqueue(t)})}})}let fe;function se(r){return r.reduce((e,t)=>e+t.length,0)}function re(r,e){if(r[0].length===e)return r.shift();const t=new Uint8Array(e);let s=0;for(let n=0;n<e;n++)t[n]=r[0][s++],s===r[0].length&&(r.shift(),s=0);return r.length&&s<r[0].length&&(r[0]=r[0].slice(s)),t}function tr(r,e){fe||(fe=new TextDecoder);const t=[];let s=0,n=-1,o=!1;return new TransformStream({transform(i,c){for(t.push(i);;){if(s===0){if(se(t)<1)break;const u=re(t,1);o=(u[0]&128)===128,n=u[0]&127,n<126?s=3:n===126?s=1:s=2}else if(s===1){if(se(t)<2)break;const u=re(t,2);n=new DataView(u.buffer,u.byteOffset,u.length).getUint16(0),s=3}else if(s===2){if(se(t)<8)break;const u=re(t,8),h=new DataView(u.buffer,u.byteOffset,u.length),d=h.getUint32(0);if(d>Math.pow(2,21)-1){c.enqueue(be);break}n=d*Math.pow(2,32)+h.getUint32(4),s=3}else{if(se(t)<n)break;const u=re(t,n);c.enqueue(xe(o?u:fe.decode(u),e)),s=0}if(n===0||n>r){c.enqueue(be);break}}}})}const ct=4;function k(r){if(r)return sr(r)}function sr(r){for(var e in k.prototype)r[e]=k.prototype[e];return r}k.prototype.on=k.prototype.addEventListener=function(r,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+r]=this._callbacks["$"+r]||[]).push(e),this};k.prototype.once=function(r,e){function t(){this.off(r,t),e.apply(this,arguments)}return t.fn=e,this.on(r,t),this};k.prototype.off=k.prototype.removeListener=k.prototype.removeAllListeners=k.prototype.removeEventListener=function(r,e){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var t=this._callbacks["$"+r];if(!t)return this;if(arguments.length==1)return delete this._callbacks["$"+r],this;for(var s,n=0;n<t.length;n++)if(s=t[n],s===e||s.fn===e){t.splice(n,1);break}return t.length===0&&delete this._callbacks["$"+r],this};k.prototype.emit=function(r){this._callbacks=this._callbacks||{};for(var e=new Array(arguments.length-1),t=this._callbacks["$"+r],s=1;s<arguments.length;s++)e[s-1]=arguments[s];if(t){t=t.slice(0);for(var s=0,n=t.length;s<n;++s)t[s].apply(this,e)}return this};k.prototype.emitReserved=k.prototype.emit;k.prototype.listeners=function(r){return this._callbacks=this._callbacks||{},this._callbacks["$"+r]||[]};k.prototype.hasListeners=function(r){return!!this.listeners(r).length};const he=typeof Promise=="function"&&typeof Promise.resolve=="function"?e=>Promise.resolve().then(e):(e,t)=>t(e,0),T=typeof self<"u"?self:typeof window<"u"?window:Function("return this")(),rr="arraybuffer";function ut(r,...e){return e.reduce((t,s)=>(r.hasOwnProperty(s)&&(t[s]=r[s]),t),{})}const nr=T.setTimeout,or=T.clearTimeout;function le(r,e){e.useNativeTimers?(r.setTimeoutFn=nr.bind(T),r.clearTimeoutFn=or.bind(T)):(r.setTimeoutFn=T.setTimeout.bind(T),r.clearTimeoutFn=T.clearTimeout.bind(T))}const ir=1.33;function ar(r){return typeof r=="string"?cr(r):Math.ceil((r.byteLength||r.size)*ir)}function cr(r){let e=0,t=0;for(let s=0,n=r.length;s<n;s++)e=r.charCodeAt(s),e<128?t+=1:e<2048?t+=2:e<55296||e>=57344?t+=3:(s++,t+=4);return t}function ht(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}function ur(r){let e="";for(let t in r)r.hasOwnProperty(t)&&(e.length&&(e+="&"),e+=encodeURIComponent(t)+"="+encodeURIComponent(r[t]));return e}function hr(r){let e={},t=r.split("&");for(let s=0,n=t.length;s<n;s++){let o=t[s].split("=");e[decodeURIComponent(o[0])]=decodeURIComponent(o[1])}return e}class lr extends Error{constructor(e,t,s){super(e),this.description=t,this.context=s,this.type="TransportError"}}class Re extends k{constructor(e){super(),this.writable=!1,le(this,e),this.opts=e,this.query=e.query,this.socket=e.socket,this.supportsBinary=!e.forceBase64}onError(e,t,s){return super.emitReserved("error",new lr(e,t,s)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(e){this.readyState==="open"&&this.write(e)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(e){const t=xe(e,this.socket.binaryType);this.onPacket(t)}onPacket(e){super.emitReserved("packet",e)}onClose(e){this.readyState="closed",super.emitReserved("close",e)}pause(e){}createUri(e,t={}){return e+"://"+this._hostname()+this._port()+this.opts.path+this._query(t)}_hostname(){const e=this.opts.hostname;return e.indexOf(":")===-1?e:"["+e+"]"}_port(){return this.opts.port&&(this.opts.secure&&+(this.opts.port!==443)||!this.opts.secure&&Number(this.opts.port)!==80)?":"+this.opts.port:""}_query(e){const t=ur(e);return t.length?"?"+t:""}}class dr extends Re{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(e){this.readyState="pausing";const t=()=>{this.readyState="paused",e()};if(this._polling||!this.writable){let s=0;this._polling&&(s++,this.once("pollComplete",function(){--s||t()})),this.writable||(s++,this.once("drain",function(){--s||t()}))}else t()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(e){const t=s=>{if(this.readyState==="opening"&&s.type==="open"&&this.onOpen(),s.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(s)};Zs(e,this.socket.binaryType).forEach(t),this.readyState!=="closed"&&(this._polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this._poll())}doClose(){const e=()=>{this.write([{type:"close"}])};this.readyState==="open"?e():this.once("open",e)}write(e){this.writable=!1,js(e,t=>{this.doWrite(t,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){const e=this.opts.secure?"https":"http",t=this.query||{};return this.opts.timestampRequests!==!1&&(t[this.opts.timestampParam]=ht()),!this.supportsBinary&&!t.sid&&(t.b64=1),this.createUri(e,t)}}let lt=!1;try{lt=typeof XMLHttpRequest<"u"&&"withCredentials"in new XMLHttpRequest}catch{}const pr=lt;function fr(){}class gr extends dr{constructor(e){if(super(e),typeof location<"u"){const t=location.protocol==="https:";let s=location.port;s||(s=t?"443":"80"),this.xd=typeof location<"u"&&e.hostname!==location.hostname||s!==e.port}}doWrite(e,t){const s=this.request({method:"POST",data:e});s.on("success",t),s.on("error",(n,o)=>{this.onError("xhr post error",n,o)})}doPoll(){const e=this.request();e.on("data",this.onData.bind(this)),e.on("error",(t,s)=>{this.onError("xhr poll error",t,s)}),this.pollXhr=e}}class N extends k{constructor(e,t,s){super(),this.createRequest=e,le(this,s),this._opts=s,this._method=s.method||"GET",this._uri=t,this._data=s.data!==void 0?s.data:null,this._create()}_create(){var e;const t=ut(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");t.xdomain=!!this._opts.xd;const s=this._xhr=this.createRequest(t);try{s.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){s.setDisableHeaderCheck&&s.setDisableHeaderCheck(!0);for(let n in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(n)&&s.setRequestHeader(n,this._opts.extraHeaders[n])}}catch{}if(this._method==="POST")try{s.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch{}try{s.setRequestHeader("Accept","*/*")}catch{}(e=this._opts.cookieJar)===null||e===void 0||e.addCookies(s),"withCredentials"in s&&(s.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(s.timeout=this._opts.requestTimeout),s.onreadystatechange=()=>{var n;s.readyState===3&&((n=this._opts.cookieJar)===null||n===void 0||n.parseCookies(s.getResponseHeader("set-cookie"))),s.readyState===4&&(s.status===200||s.status===1223?this._onLoad():this.setTimeoutFn(()=>{this._onError(typeof s.status=="number"?s.status:0)},0))},s.send(this._data)}catch(n){this.setTimeoutFn(()=>{this._onError(n)},0);return}typeof document<"u"&&(this._index=N.requestsCount++,N.requests[this._index]=this)}_onError(e){this.emitReserved("error",e,this._xhr),this._cleanup(!0)}_cleanup(e){if(!(typeof this._xhr>"u"||this._xhr===null)){if(this._xhr.onreadystatechange=fr,e)try{this._xhr.abort()}catch{}typeof document<"u"&&delete N.requests[this._index],this._xhr=null}}_onLoad(){const e=this._xhr.responseText;e!==null&&(this.emitReserved("data",e),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}N.requestsCount=0;N.requests={};if(typeof document<"u"){if(typeof attachEvent=="function")attachEvent("onunload",Xe);else if(typeof addEventListener=="function"){const r="onpagehide"in T?"pagehide":"unload";addEventListener(r,Xe,!1)}}function Xe(){for(let r in N.requests)N.requests.hasOwnProperty(r)&&N.requests[r].abort()}const mr=function(){const r=dt({xdomain:!1});return r&&r.responseType!==null}();class yr extends gr{constructor(e){super(e);const t=e&&e.forceBase64;this.supportsBinary=mr&&!t}request(e={}){return Object.assign(e,{xd:this.xd},this.opts),new N(dt,this.uri(),e)}}function dt(r){const e=r.xdomain;try{if(typeof XMLHttpRequest<"u"&&(!e||pr))return new XMLHttpRequest}catch{}if(!e)try{return new T[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch{}}const pt=typeof navigator<"u"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative";class wr extends Re{get name(){return"websocket"}doOpen(){const e=this.uri(),t=this.opts.protocols,s=pt?{}:ut(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(s.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(e,t,s)}catch(n){return this.emitReserved("error",n)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=e=>this.onClose({description:"websocket connection closed",context:e}),this.ws.onmessage=e=>this.onData(e.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const s=e[t],n=t===e.length-1;Ae(s,this.supportsBinary,o=>{try{this.doWrite(s,o)}catch{}n&&he(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws<"u"&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const e=this.opts.secure?"wss":"ws",t=this.query||{};return this.opts.timestampRequests&&(t[this.opts.timestampParam]=ht()),this.supportsBinary||(t.b64=1),this.createUri(e,t)}}const ge=T.WebSocket||T.MozWebSocket;class kr extends wr{createSocket(e,t,s){return pt?new ge(e,t,s):t?new ge(e,t):new ge(e)}doWrite(e,t){this.ws.send(t)}}class br extends Re{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(e){return this.emitReserved("error",e)}this._transport.closed.then(()=>{this.onClose()}).catch(e=>{this.onError("webtransport error",e)}),this._transport.ready.then(()=>{this._transport.createBidirectionalStream().then(e=>{const t=tr(Number.MAX_SAFE_INTEGER,this.socket.binaryType),s=e.readable.pipeThrough(t).getReader(),n=er();n.readable.pipeTo(e.writable),this._writer=n.writable.getWriter();const o=()=>{s.read().then(({done:c,value:u})=>{c||(this.onPacket(u),o())}).catch(c=>{})};o();const i={type:"open"};this.query.sid&&(i.data=`{"sid":"${this.query.sid}"}`),this._writer.write(i).then(()=>this.onOpen())})})}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const s=e[t],n=t===e.length-1;this._writer.write(s).then(()=>{n&&he(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var e;(e=this._transport)===null||e===void 0||e.close()}}const Sr={websocket:kr,webtransport:br,polling:yr},_r=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,vr=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function Se(r){if(r.length>8e3)throw"URI too long";const e=r,t=r.indexOf("["),s=r.indexOf("]");t!=-1&&s!=-1&&(r=r.substring(0,t)+r.substring(t,s).replace(/:/g,";")+r.substring(s,r.length));let n=_r.exec(r||""),o={},i=14;for(;i--;)o[vr[i]]=n[i]||"";return t!=-1&&s!=-1&&(o.source=e,o.host=o.host.substring(1,o.host.length-1).replace(/;/g,":"),o.authority=o.authority.replace("[","").replace("]","").replace(/;/g,":"),o.ipv6uri=!0),o.pathNames=Er(o,o.path),o.queryKey=Tr(o,o.query),o}function Er(r,e){const t=/\/{2,9}/g,s=e.replace(t,"/").split("/");return(e.slice(0,1)=="/"||e.length===0)&&s.splice(0,1),e.slice(-1)=="/"&&s.splice(s.length-1,1),s}function Tr(r,e){const t={};return e.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(s,n,o){n&&(t[n]=o)}),t}const _e=typeof addEventListener=="function"&&typeof removeEventListener=="function",ae=[];_e&&addEventListener("offline",()=>{ae.forEach(r=>r())},!1);class I extends k{constructor(e,t){if(super(),this.binaryType=rr,this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,e&&typeof e=="object"&&(t=e,e=null),e){const s=Se(e);t.hostname=s.host,t.secure=s.protocol==="https"||s.protocol==="wss",t.port=s.port,s.query&&(t.query=s.query)}else t.host&&(t.hostname=Se(t.host).host);le(this,t),this.secure=t.secure!=null?t.secure:typeof location<"u"&&location.protocol==="https:",t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.hostname=t.hostname||(typeof location<"u"?location.hostname:"localhost"),this.port=t.port||(typeof location<"u"&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},t.transports.forEach(s=>{const n=s.prototype.name;this.transports.push(n),this._transportsByName[n]=s}),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},t),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=hr(this.opts.query)),_e&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},ae.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(e){const t=Object.assign({},this.opts.query);t.EIO=ct,t.transport=e,this.id&&(t.sid=this.id);const s=Object.assign({},this.opts,{query:t,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[e]);return new this._transportsByName[e](s)}_open(){if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}const e=this.opts.rememberUpgrade&&I.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1?"websocket":this.transports[0];this.readyState="opening";const t=this.createTransport(e);t.open(),this.setTransport(t)}setTransport(e){this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",t=>this._onClose("transport close",t))}onOpen(){this.readyState="open",I.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush()}_onPacket(e){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const t=new Error("server error");t.code=e.data,this._onError(t);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data);break}}onHandshake(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this._pingInterval=e.pingInterval,this._pingTimeout=e.pingTimeout,this._maxPayload=e.maxPayload,this.onOpen(),this.readyState!=="closed"&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const e=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+e,this._pingTimeoutTimer=this.setTimeoutFn(()=>{this._onClose("ping timeout")},e),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const e=this._getWritablePackets();this.transport.send(e),this._prevBufferLen=e.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let t=1;for(let s=0;s<this.writeBuffer.length;s++){const n=this.writeBuffer[s].data;if(n&&(t+=ar(n)),s>0&&t>this._maxPayload)return this.writeBuffer.slice(0,s);t+=2}return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const e=Date.now()>this._pingTimeoutTime;return e&&(this._pingTimeoutTime=0,he(()=>{this._onClose("ping timeout")},this.setTimeoutFn)),e}write(e,t,s){return this._sendPacket("message",e,t,s),this}send(e,t,s){return this._sendPacket("message",e,t,s),this}_sendPacket(e,t,s,n){if(typeof t=="function"&&(n=t,t=void 0),typeof s=="function"&&(n=s,s=null),this.readyState==="closing"||this.readyState==="closed")return;s=s||{},s.compress=s.compress!==!1;const o={type:e,data:t,options:s};this.emitReserved("packetCreate",o),this.writeBuffer.push(o),n&&this.once("flush",n),this.flush()}close(){const e=()=>{this._onClose("forced close"),this.transport.close()},t=()=>{this.off("upgrade",t),this.off("upgradeError",t),e()},s=()=>{this.once("upgrade",t),this.once("upgradeError",t)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?s():e()}):this.upgrading?s():e()),this}_onError(e){if(I.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&this.readyState==="opening")return this.transports.shift(),this._open();this.emitReserved("error",e),this._onClose("transport error",e)}_onClose(e,t){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing"){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),_e&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const s=ae.indexOf(this._offlineEventListener);s!==-1&&ae.splice(s,1)}this.readyState="closed",this.id=null,this.emitReserved("close",e,t),this.writeBuffer=[],this._prevBufferLen=0}}}I.protocol=ct;class Cr extends I{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),this.readyState==="open"&&this.opts.upgrade)for(let e=0;e<this._upgrades.length;e++)this._probe(this._upgrades[e])}_probe(e){let t=this.createTransport(e),s=!1;I.priorWebsocketSuccess=!1;const n=()=>{s||(t.send([{type:"ping",data:"probe"}]),t.once("packet",l=>{if(!s)if(l.type==="pong"&&l.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",t),!t)return;I.priorWebsocketSuccess=t.name==="websocket",this.transport.pause(()=>{s||this.readyState!=="closed"&&(d(),this.setTransport(t),t.send([{type:"upgrade"}]),this.emitReserved("upgrade",t),t=null,this.upgrading=!1,this.flush())})}else{const p=new Error("probe error");p.transport=t.name,this.emitReserved("upgradeError",p)}}))};function o(){s||(s=!0,d(),t.close(),t=null)}const i=l=>{const p=new Error("probe error: "+l);p.transport=t.name,o(),this.emitReserved("upgradeError",p)};function c(){i("transport closed")}function u(){i("socket closed")}function h(l){t&&l.name!==t.name&&o()}const d=()=>{t.removeListener("open",n),t.removeListener("error",i),t.removeListener("close",c),this.off("close",u),this.off("upgrading",h)};t.once("open",n),t.once("error",i),t.once("close",c),this.once("close",u),this.once("upgrading",h),this._upgrades.indexOf("webtransport")!==-1&&e!=="webtransport"?this.setTimeoutFn(()=>{s||t.open()},200):t.open()}onHandshake(e){this._upgrades=this._filterUpgrades(e.upgrades),super.onHandshake(e)}_filterUpgrades(e){const t=[];for(let s=0;s<e.length;s++)~this.transports.indexOf(e[s])&&t.push(e[s]);return t}}let Mr=class extends Cr{constructor(e,t={}){const s=typeof e=="object"?e:t;(!s.transports||s.transports&&typeof s.transports[0]=="string")&&(s.transports=(s.transports||["polling","websocket","webtransport"]).map(n=>Sr[n]).filter(n=>!!n)),super(e,s)}};function Ar(r,e="",t){let s=r;t=t||typeof location<"u"&&location,r==null&&(r=t.protocol+"//"+t.host),typeof r=="string"&&(r.charAt(0)==="/"&&(r.charAt(1)==="/"?r=t.protocol+r:r=t.host+r),/^(https?|wss?):\/\//.test(r)||(typeof t<"u"?r=t.protocol+"//"+r:r="https://"+r),s=Se(r)),s.port||(/^(http|ws)$/.test(s.protocol)?s.port="80":/^(http|ws)s$/.test(s.protocol)&&(s.port="443")),s.path=s.path||"/";const o=s.host.indexOf(":")!==-1?"["+s.host+"]":s.host;return s.id=s.protocol+"://"+o+":"+s.port+e,s.href=s.protocol+"://"+o+(t&&t.port===s.port?"":":"+s.port),s}const xr=typeof ArrayBuffer=="function",Rr=r=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(r):r.buffer instanceof ArrayBuffer,ft=Object.prototype.toString,Br=typeof Blob=="function"||typeof Blob<"u"&&ft.call(Blob)==="[object BlobConstructor]",Nr=typeof File=="function"||typeof File<"u"&&ft.call(File)==="[object FileConstructor]";function Be(r){return xr&&(r instanceof ArrayBuffer||Rr(r))||Br&&r instanceof Blob||Nr&&r instanceof File}function ce(r,e){if(!r||typeof r!="object")return!1;if(Array.isArray(r)){for(let t=0,s=r.length;t<s;t++)if(ce(r[t]))return!0;return!1}if(Be(r))return!0;if(r.toJSON&&typeof r.toJSON=="function"&&arguments.length===1)return ce(r.toJSON(),!0);for(const t in r)if(Object.prototype.hasOwnProperty.call(r,t)&&ce(r[t]))return!0;return!1}function Lr(r){const e=[],t=r.data,s=r;return s.data=ve(t,e),s.attachments=e.length,{packet:s,buffers:e}}function ve(r,e){if(!r)return r;if(Be(r)){const t={_placeholder:!0,num:e.length};return e.push(r),t}else if(Array.isArray(r)){const t=new Array(r.length);for(let s=0;s<r.length;s++)t[s]=ve(r[s],e);return t}else if(typeof r=="object"&&!(r instanceof Date)){const t={};for(const s in r)Object.prototype.hasOwnProperty.call(r,s)&&(t[s]=ve(r[s],e));return t}return r}function Pr(r,e){return r.data=Ee(r.data,e),delete r.attachments,r}function Ee(r,e){if(!r)return r;if(r&&r._placeholder===!0){if(typeof r.num=="number"&&r.num>=0&&r.num<e.length)return e[r.num];throw new Error("illegal attachments")}else if(Array.isArray(r))for(let t=0;t<r.length;t++)r[t]=Ee(r[t],e);else if(typeof r=="object")for(const t in r)Object.prototype.hasOwnProperty.call(r,t)&&(r[t]=Ee(r[t],e));return r}const Or=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"],Dr=5;var f;(function(r){r[r.CONNECT=0]="CONNECT",r[r.DISCONNECT=1]="DISCONNECT",r[r.EVENT=2]="EVENT",r[r.ACK=3]="ACK",r[r.CONNECT_ERROR=4]="CONNECT_ERROR",r[r.BINARY_EVENT=5]="BINARY_EVENT",r[r.BINARY_ACK=6]="BINARY_ACK"})(f||(f={}));class Ir{constructor(e){this.replacer=e}encode(e){return(e.type===f.EVENT||e.type===f.ACK)&&ce(e)?this.encodeAsBinary({type:e.type===f.EVENT?f.BINARY_EVENT:f.BINARY_ACK,nsp:e.nsp,data:e.data,id:e.id}):[this.encodeAsString(e)]}encodeAsString(e){let t=""+e.type;return(e.type===f.BINARY_EVENT||e.type===f.BINARY_ACK)&&(t+=e.attachments+"-"),e.nsp&&e.nsp!=="/"&&(t+=e.nsp+","),e.id!=null&&(t+=e.id),e.data!=null&&(t+=JSON.stringify(e.data,this.replacer)),t}encodeAsBinary(e){const t=Lr(e),s=this.encodeAsString(t.packet),n=t.buffers;return n.unshift(s),n}}function Je(r){return Object.prototype.toString.call(r)==="[object Object]"}class Ne extends k{constructor(e){super(),this.reviver=e}add(e){let t;if(typeof e=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");t=this.decodeString(e);const s=t.type===f.BINARY_EVENT;s||t.type===f.BINARY_ACK?(t.type=s?f.EVENT:f.ACK,this.reconstructor=new Fr(t),t.attachments===0&&super.emitReserved("decoded",t)):super.emitReserved("decoded",t)}else if(Be(e)||e.base64)if(this.reconstructor)t=this.reconstructor.takeBinaryData(e),t&&(this.reconstructor=null,super.emitReserved("decoded",t));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+e)}decodeString(e){let t=0;const s={type:Number(e.charAt(0))};if(f[s.type]===void 0)throw new Error("unknown packet type "+s.type);if(s.type===f.BINARY_EVENT||s.type===f.BINARY_ACK){const o=t+1;for(;e.charAt(++t)!=="-"&&t!=e.length;);const i=e.substring(o,t);if(i!=Number(i)||e.charAt(t)!=="-")throw new Error("Illegal attachments");s.attachments=Number(i)}if(e.charAt(t+1)==="/"){const o=t+1;for(;++t&&!(e.charAt(t)===","||t===e.length););s.nsp=e.substring(o,t)}else s.nsp="/";const n=e.charAt(t+1);if(n!==""&&Number(n)==n){const o=t+1;for(;++t;){const i=e.charAt(t);if(i==null||Number(i)!=i){--t;break}if(t===e.length)break}s.id=Number(e.substring(o,t+1))}if(e.charAt(++t)){const o=this.tryParse(e.substr(t));if(Ne.isPayloadValid(s.type,o))s.data=o;else throw new Error("invalid payload")}return s}tryParse(e){try{return JSON.parse(e,this.reviver)}catch{return!1}}static isPayloadValid(e,t){switch(e){case f.CONNECT:return Je(t);case f.DISCONNECT:return t===void 0;case f.CONNECT_ERROR:return typeof t=="string"||Je(t);case f.EVENT:case f.BINARY_EVENT:return Array.isArray(t)&&(typeof t[0]=="number"||typeof t[0]=="string"&&Or.indexOf(t[0])===-1);case f.ACK:case f.BINARY_ACK:return Array.isArray(t)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class Fr{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){const t=Pr(this.reconPack,this.buffers);return this.finishedReconstruction(),t}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}const Ur=Object.freeze(Object.defineProperty({__proto__:null,Decoder:Ne,Encoder:Ir,get PacketType(){return f},protocol:Dr},Symbol.toStringTag,{value:"Module"}));function M(r,e,t){return r.on(e,t),function(){r.off(e,t)}}const $r=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class gt extends k{constructor(e,t,s){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=t,s&&s.auth&&(this.auth=s.auth),this._opts=Object.assign({},s),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const e=this.io;this.subs=[M(e,"open",this.onopen.bind(this)),M(e,"packet",this.onpacket.bind(this)),M(e,"error",this.onerror.bind(this)),M(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...t){var s,n,o;if($r.hasOwnProperty(e))throw new Error('"'+e.toString()+'" is a reserved event name');if(t.unshift(e),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(t),this;const i={type:f.EVENT,data:t};if(i.options={},i.options.compress=this.flags.compress!==!1,typeof t[t.length-1]=="function"){const d=this.ids++,l=t.pop();this._registerAckCallback(d,l),i.id=d}const c=(n=(s=this.io.engine)===null||s===void 0?void 0:s.transport)===null||n===void 0?void 0:n.writable,u=this.connected&&!(!((o=this.io.engine)===null||o===void 0)&&o._hasPingExpired());return this.flags.volatile&&!c||(u?(this.notifyOutgoingListeners(i),this.packet(i)):this.sendBuffer.push(i)),this.flags={},this}_registerAckCallback(e,t){var s;const n=(s=this.flags.timeout)!==null&&s!==void 0?s:this._opts.ackTimeout;if(n===void 0){this.acks[e]=t;return}const o=this.io.setTimeoutFn(()=>{delete this.acks[e];for(let c=0;c<this.sendBuffer.length;c++)this.sendBuffer[c].id===e&&this.sendBuffer.splice(c,1);t.call(this,new Error("operation has timed out"))},n),i=(...c)=>{this.io.clearTimeoutFn(o),t.apply(this,c)};i.withError=!0,this.acks[e]=i}emitWithAck(e,...t){return new Promise((s,n)=>{const o=(i,c)=>i?n(i):s(c);o.withError=!0,t.push(o),this.emit(e,...t)})}_addToQueue(e){let t;typeof e[e.length-1]=="function"&&(t=e.pop());const s={id:this._queueSeq++,tryCount:0,pending:!1,args:e,flags:Object.assign({fromQueue:!0},this.flags)};e.push((n,...o)=>s!==this._queue[0]?void 0:(n!==null?s.tryCount>this._opts.retries&&(this._queue.shift(),t&&t(n)):(this._queue.shift(),t&&t(null,...o)),s.pending=!1,this._drainQueue())),this._queue.push(s),this._drainQueue()}_drainQueue(e=!1){if(!this.connected||this._queue.length===0)return;const t=this._queue[0];t.pending&&!e||(t.pending=!0,t.tryCount++,this.flags=t.flags,this.emit.apply(this,t.args))}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){typeof this.auth=="function"?this.auth(e=>{this._sendConnectPacket(e)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(e){this.packet({type:f.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},e):e})}onerror(e){this.connected||this.emitReserved("connect_error",e)}onclose(e,t){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,t),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach(e=>{if(!this.sendBuffer.some(s=>String(s.id)===e)){const s=this.acks[e];delete this.acks[e],s.withError&&s.call(this,new Error("socket has been disconnected"))}})}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case f.CONNECT:e.data&&e.data.sid?this.onconnect(e.data.sid,e.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case f.EVENT:case f.BINARY_EVENT:this.onevent(e);break;case f.ACK:case f.BINARY_ACK:this.onack(e);break;case f.DISCONNECT:this.ondisconnect();break;case f.CONNECT_ERROR:this.destroy();const s=new Error(e.data.message);s.data=e.data.data,this.emitReserved("connect_error",s);break}}onevent(e){const t=e.data||[];e.id!=null&&t.push(this.ack(e.id)),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){const t=this._anyListeners.slice();for(const s of t)s.apply(this,e)}super.emit.apply(this,e),this._pid&&e.length&&typeof e[e.length-1]=="string"&&(this._lastOffset=e[e.length-1])}ack(e){const t=this;let s=!1;return function(...n){s||(s=!0,t.packet({type:f.ACK,id:e,data:n}))}}onack(e){const t=this.acks[e.id];typeof t=="function"&&(delete this.acks[e.id],t.withError&&e.data.unshift(null),t.apply(this,e.data))}onconnect(e,t){this.id=e,this.recovered=t&&this._pid===t,this._pid=t,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach(e=>this.emitEvent(e)),this.receiveBuffer=[],this.sendBuffer.forEach(e=>{this.notifyOutgoingListeners(e),this.packet(e)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(e=>e()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:f.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}timeout(e){return this.flags.timeout=e,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const t=this._anyListeners;for(let s=0;s<t.length;s++)if(e===t[s])return t.splice(s,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}prependAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}offAnyOutgoing(e){if(!this._anyOutgoingListeners)return this;if(e){const t=this._anyOutgoingListeners;for(let s=0;s<t.length;s++)if(e===t[s])return t.splice(s,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const t=this._anyOutgoingListeners.slice();for(const s of t)s.apply(this,e.data)}}}function G(r){r=r||{},this.ms=r.min||100,this.max=r.max||1e4,this.factor=r.factor||2,this.jitter=r.jitter>0&&r.jitter<=1?r.jitter:0,this.attempts=0}G.prototype.duration=function(){var r=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random(),t=Math.floor(e*this.jitter*r);r=Math.floor(e*10)&1?r+t:r-t}return Math.min(r,this.max)|0};G.prototype.reset=function(){this.attempts=0};G.prototype.setMin=function(r){this.ms=r};G.prototype.setMax=function(r){this.max=r};G.prototype.setJitter=function(r){this.jitter=r};class Te extends k{constructor(e,t){var s;super(),this.nsps={},this.subs=[],e&&typeof e=="object"&&(t=e,e=void 0),t=t||{},t.path=t.path||"/socket.io",this.opts=t,le(this,t),this.reconnection(t.reconnection!==!1),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor((s=t.randomizationFactor)!==null&&s!==void 0?s:.5),this.backoff=new G({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(t.timeout==null?2e4:t.timeout),this._readyState="closed",this.uri=e;const n=t.parser||Ur;this.encoder=new n.Encoder,this.decoder=new n.Decoder,this._autoConnect=t.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,e||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(e){return e===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var t;return e===void 0?this._reconnectionDelay:(this._reconnectionDelay=e,(t=this.backoff)===null||t===void 0||t.setMin(e),this)}randomizationFactor(e){var t;return e===void 0?this._randomizationFactor:(this._randomizationFactor=e,(t=this.backoff)===null||t===void 0||t.setJitter(e),this)}reconnectionDelayMax(e){var t;return e===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,(t=this.backoff)===null||t===void 0||t.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(e){if(~this._readyState.indexOf("open"))return this;this.engine=new Mr(this.uri,this.opts);const t=this.engine,s=this;this._readyState="opening",this.skipReconnect=!1;const n=M(t,"open",function(){s.onopen(),e&&e()}),o=c=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",c),e?e(c):this.maybeReconnectOnOpen()},i=M(t,"error",o);if(this._timeout!==!1){const c=this._timeout,u=this.setTimeoutFn(()=>{n(),o(new Error("timeout")),t.close()},c);this.opts.autoUnref&&u.unref(),this.subs.push(()=>{this.clearTimeoutFn(u)})}return this.subs.push(n),this.subs.push(i),this}connect(e){return this.open(e)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const e=this.engine;this.subs.push(M(e,"ping",this.onping.bind(this)),M(e,"data",this.ondata.bind(this)),M(e,"error",this.onerror.bind(this)),M(e,"close",this.onclose.bind(this)),M(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(e){try{this.decoder.add(e)}catch(t){this.onclose("parse error",t)}}ondecoded(e){he(()=>{this.emitReserved("packet",e)},this.setTimeoutFn)}onerror(e){this.emitReserved("error",e)}socket(e,t){let s=this.nsps[e];return s?this._autoConnect&&!s.active&&s.connect():(s=new gt(this,e,t),this.nsps[e]=s),s}_destroy(e){const t=Object.keys(this.nsps);for(const s of t)if(this.nsps[s].active)return;this._close()}_packet(e){const t=this.encoder.encode(e);for(let s=0;s<t.length;s++)this.engine.write(t[s],e.options)}cleanup(){this.subs.forEach(e=>e()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(e,t){var s;this.cleanup(),(s=this.engine)===null||s===void 0||s.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,t),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const t=this.backoff.duration();this._reconnecting=!0;const s=this.setTimeoutFn(()=>{e.skipReconnect||(this.emitReserved("reconnect_attempt",e.backoff.attempts),!e.skipReconnect&&e.open(n=>{n?(e._reconnecting=!1,e.reconnect(),this.emitReserved("reconnect_error",n)):e.onreconnect()}))},t);this.opts.autoUnref&&s.unref(),this.subs.push(()=>{this.clearTimeoutFn(s)})}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}const Y={};function ue(r,e){typeof r=="object"&&(e=r,r=void 0),e=e||{};const t=Ar(r,e.path||"/socket.io"),s=t.source,n=t.id,o=t.path,i=Y[n]&&o in Y[n].nsps,c=e.forceNew||e["force new connection"]||e.multiplex===!1||i;let u;return c?u=new Te(s,e):(Y[n]||(Y[n]=new Te(s,e)),u=Y[n]),t.query&&!e.query&&(e.query=t.queryKey),u.socket(t.path,e)}Object.assign(ue,{Manager:Te,Socket:gt,io:ue,connect:ue});class mt{constructor(e,t,s){g(this,"sessionManager");g(this,"actionExecutor");g(this,"endpoint");g(this,"version");g(this,"socket",null);g(this,"clientId","");this.sessionManager=e,this.actionExecutor=t;const{socketEndpoint:n}=$.getEnvParams();this.endpoint=n,this.version=Nt(),this.registerAuthListener()}emitUpstream(e){if(!this.socket){a.error("Socket not connected; cannot emit message",e);return}const t=q.getBrowserSettings(),s={id:ne(),timestamp:Date.now(),clientId:this.clientId,ua:navigator.userAgent,version:this.version,browserName:t==null?void 0:t.browserName,allowOtherClient:t==null?void 0:t.allowCrossBrowser,skipAuthorization:(t==null?void 0:t.skipAuthorization)??!1};this.socket.emit("my_browser_extension_message",{...s,...e})}async connectSocket(e=!1){if(this.socket){if(!e){a.warn("Failed to start socket.io connection. SocketBridge already started");return}a.info("Restarting socket.io connection, tearing down previous socket instance"),this.socket.removeAllListeners(),this.socket.disconnect(),this.socket=null}const t=J.getToken(),s=me.getDevBranch();this.clientId=await j(),a.info("Connecting to Manus Node Server Socket.IO bridge",{endpoint:this.endpoint,restart:e});const n={token:t??""};s&&(n.branch=s);const o={transports:["websocket"],autoConnect:!0,reconnection:!0,reconnectionAttempts:1/0,reconnectionDelay:1e3,reconnectionDelayMax:5e3,query:n};a.debug("Connecting to Manus Node Server Socket.IO bridge",{payload:o}),this.socket=ue(this.endpoint,o),this.socket.on("connect",()=>{this.emitExtensionActivation()}),this.socket.on("disconnect",i=>{a.warn("Socket.IO disconnected",{reason:i})}),this.socket.on("connect_error",i=>{a.error("Socket.IO connection error",{error:i.message})}),this.socket.on("ping",(i,c)=>{c({status:"success",message:"pong"})}),this.socket.on("my_browser_extension_message",(i,c)=>{if(!("clientId"in i&&!this.checkMessageValidity(i.clientId)))switch(i.type){case"browser_action":this.handleBrowserActionRequest(i,c);break;case"session_status":this.handleSessionTaskRequest(i);break;case"my_browser_extension_connected":a.info("My Browser Extension connected",i);break;default:a.warn("Unknown message type",{payload:i})}})}emitDisconnectSession(e,t){const s={type:"disconnect_session",sessionId:e,reason:t};this.emitUpstream(s)}emitStopSession(e){e&&this.emitEventLog(e,"upstream","extension_stop_session",{}),this.emitUpstream({type:"extension_stop_session",sessionId:e})}emitTakeOverSummary(e,t){this.emitEventLog(e,"upstream","extension_take_over_summary",{summaryLength:t.length}),this.emitUpstream({type:"extension_take_over_summary",sessionId:e,summary:t})}emitExtensionActivation(){this.emitUpstream({type:"activate_extension"})}registerAuthListener(){const e=()=>{this.emitExtensionActivation()};q.subscribeBrowserSettings(e);const t=()=>{a.warn("[SocketBridge] token or devBranch changed, restarting socket.io connection"),this.connectSocket(!0)};J.subscribeToken(t),me.subscribeDevBranch(t)}checkMessageValidity(e){return e!==this.clientId?(a.error("Client ID mismatch",{receivedClientId:e,myClientId:this.clientId}),!1):!0}async handleSessionTaskRequest(e){const{sessionId:t,status:s}=e;try{this.emitEventLog(t,"downstream","session_status",{status:s,sessionTitle:e.sessionTitle,error:e.error}),await this.sessionManager.enqueue(t,async n=>{const i={running:"running",stopped:"completed",error:"stopped",take_over:"takeover"}[s];if(!i){a.warn("[SocketBridge] Unknown session status, doing nothing",{status:s});return}await this.sessionManager.updateSessionStatus(t,{status:i,taskName:e==null?void 0:e.sessionTitle})})}catch(n){const o=n instanceof Error?n.message:String(n);throw a.error("error handling session task request",{status:s,error:o}),n}}async handleBrowserActionRequest(e,t){const{sessionId:s,id:n,type:o,action:i}=e,c=h=>{t(h)};this.emitEventLog(s,"downstream","browser_action",{actionId:n,action:i});let u;try{u=je(e.action)}catch(h){const d=h instanceof Error?h.message:String(h);a.error("Action conversion error",{sessionId:s,actionId:n,error:d}),c({sessionId:s,clientId:this.clientId,actionId:e.id,status:"error",result:{},error:d});return}try{const h=await this.sessionManager.enqueue(s,async d=>(await this.sessionManager.updateSessionStatus(s,{status:"running"}),this.performActionOnSession(d,e,u)));c(h)}catch(h){const d=h instanceof Error?h.message:String(h);a.error("Action execution failure",{sessionId:s,error:d}),c({sessionId:s,actionId:n,clientId:this.clientId,status:"error",result:{},error:d})}}async performActionOnSession(e,t,s){var l,p;const{sessionId:n,id:o}=t,i=await this.actionExecutor.runAction(e,s,{captureArtifacts:!0}),c=await U(e);this.emitProgressEvent(n,o,s,i);const u=i.status==="error",h={url:c.url??"",title:c.title??"",result:i.message??"success",error:!1,screenshot_uploaded:!1,clean_screenshot_uploaded:!1,clean_screenshot_path:"",elements:St(i.artifacts),markdown:((l=i.artifacts)==null?void 0:l.markdownContent)??"",full_markdown:((p=i.artifacts)==null?void 0:p.markdownContent)??"",pixels_above:0,pixels_below:0,viewport_width:void 0,viewport_height:void 0};if(!u&&i.artifacts){const m=await Ks(i.artifacts,t.screenshot_presigned_url,t.clean_screenshot_presigned_url);h.screenshot_uploaded=m.screenshot_uploaded,h.clean_screenshot_uploaded=m.clean_screenshot_uploaded}const d=u?{url:c.url??"",title:c.title??"",result:i.error||i.message||"Action failed",error:!0}:h;return{sessionId:n,actionId:o,clientId:this.clientId,status:u?"error":"success",result:d,error:u?i.error||"Action failed":void 0}}emitProgressEvent(e,t,s,n){if($.isProd())return;const o=`server-${e}-${t}`,i=n.status==="error",c={runId:o,scenarioId:`server-session-${e}`,status:i?"error":"success",action:s,message:n.message,error:n.error,artifacts:n.artifacts};Q({source:"background",type:"automation/progress",result:c}).catch(u=>{const h=u instanceof Error?u.message:String(u);a.warn("Failed to emit progress event",h)})}emitEventLog(e,t,s,n){if($.isProd())return;const o={source:"background",type:"automation/event-log",log:{sessionId:e,timestamp:Date.now(),direction:t,eventType:s,payload:n}};Q(o).catch(i=>{const c=i instanceof Error?i.message:String(i);a.warn("Failed to emit event log",c)})}}class qr extends mt{constructor(){super(...arguments);g(this,"activeMockRuns",new Map)}async connectSocket(){this.clientId=await j(),a.info("MockSocketBridge started (local mode, no real socket connection)",{clientId:this.clientId})}emitUpstream(t){a.info("[Mock] Would send upstream message:",{type:t.type,message:t})}async runMockScenario(t){const s=_t(t);if(!s)throw a.error("[Mock] âŒ Scenario not found",{scenarioId:t}),new Error(`Scenario ${t} not found`);const n=crypto.randomUUID(),o=crypto.randomUUID();return a.warn("[Mock] ðŸŽ¯ Starting scenario",{scenarioId:t,sessionId:n,runId:o,scenarioName:s.name,stepCount:s.steps.length,steps:s.steps.map((i,c)=>({index:c,type:i.type}))}),this.activeMockRuns.set(n,{cancelled:!1}),this.executeMockScenario(n,o,s).catch(i=>{a.error("[Mock] ðŸ’¥ Scenario execution failed in async handler",{scenarioId:t,sessionId:n,runId:o,error:i instanceof Error?i.message:String(i),errorStack:i instanceof Error?i.stack:void 0})}),a.warn("[Mock] âœ“ Scenario started, returning runId",{runId:o,sessionId:n}),o}async stopMockScenario(t){a.info("[Mock] Stopping all active scenarios");for(const[s,n]of this.activeMockRuns.entries())n.cancelled=!0,a.info("[Mock] Marked scenario as cancelled",{sessionId:s})}async executeMockScenario(t,s,n){const o=[],i=Date.now();let c=!1;try{a.warn("[Mock] ðŸš€ Starting scenario execution",{sessionId:t,scenarioId:n.id,scenarioName:n.name,stepCount:n.steps.length,runId:s});for(let u=0;u<n.steps.length;u++){const h=this.activeMockRuns.get(t);if(h!=null&&h.cancelled){a.info("[Mock] Scenario cancelled by user",{scenarioId:n.id,sessionId:t,stoppedAtStep:u});break}const d=n.steps[u];switch(a.warn("[Mock] ðŸŽ¬ Executing step",{sessionId:t,stepIndex:u,stepType:d.type,totalSteps:n.steps.length}),d.type){case"browser_action":{const l=`mock-action-${u}`,p=je(d.action),m={type:"browser_action",id:ne(),sessionId:t,clientId:this.clientId,timestamp:Date.now(),action:d.action};a.warn("[Mock] ðŸ“¤ Sending browser_action to handleBrowserActionRequest",{sessionId:t,actionId:l,messageId:m.id,action:m.action});const A=await new Promise((O,x)=>{this.handleBrowserActionRequest(m,y=>{a.warn("[Mock] ðŸ“¥ Received action result callback",{sessionId:t,actionId:l,status:y.status,hasError:!!y.error,error:y.error}),y.status==="error"?(a.error("[Mock] âŒ Action failed",{sessionId:t,actionId:l,error:y.error,fullResult:y}),x(new Error(y.error||"Action execution failed"))):(a.info("[Mock] âœ… Action completed successfully",{sessionId:t,actionId:l,status:y.status}),O(y))})});o.push({action:p,result:A});break}case"session_status":{const l={type:"session_status",id:ne(),sessionId:t,clientId:this.clientId,timestamp:Date.now(),status:d.status,sessionTitle:d.sessionTitle,error:d.error};a.warn("[Mock] ðŸ“¤ Sending session_status to handleSessionTaskRequest",{sessionId:t,status:d.status,sessionTitle:d.sessionTitle}),await this.handleSessionTaskRequest(l),d.status==="stopped"&&(c=!0,a.info("[Mock] âœ… Received stopped status, will send summary",{sessionId:t,runId:s})),a.info("[Mock] âœ… Session status updated",{sessionId:t,status:d.status});break}default:{const l=d;throw a.error("[Mock] Unknown step type",{sessionId:t,step:l}),new Error(`Unknown step type: ${JSON.stringify(d)}`)}}u<n.steps.length-1&&await this.delay(1e3)}if(a.warn("[Mock] ðŸ All steps executed",{scenarioId:n.id,sessionId:t,runId:s,totalSteps:n.steps.length,receivedStopStatus:c}),c){a.warn("[Mock] ðŸŽ‰ Scenario completed with stopped status",{scenarioId:n.id,sessionId:t,runId:s}),a.warn("[Mock] ðŸ“¨ Emitting automation/summary event",{runId:s,scenarioId:n.id,hasOnEmitEvent:!0,resultsCount:o.length});const u={runId:s,scenarioId:n.id,status:"success",results:o.map((h,d)=>({runId:s,scenarioId:n.id,status:"success",action:h.action,message:"Step completed"})),startedAt:i,completedAt:Date.now()};Q({source:"background",type:"automation/summary",summary:u}),a.warn("[Mock] âœ“ automation/summary event emitted",{runId:s,summaryStatus:u.status,completedAt:u.completedAt})}else a.info("[Mock] â¸ï¸ Scenario ended without stopped status (ongoing scenario)",{scenarioId:n.id,sessionId:t,runId:s})}catch(u){a.error("[Mock] ðŸ’¥ Scenario execution failed",{scenarioId:n.id,sessionId:t,runId:s,error:u instanceof Error?u.message:String(u),errorStack:u instanceof Error?u.stack:void 0}),await this.handleSessionTaskRequest({type:"session_status",id:ne(),sessionId:t,clientId:this.clientId,timestamp:Date.now(),status:"error",error:u instanceof Error?u.message:String(u)}),a.warn("[Mock] ðŸ“¨ Emitting error automation/summary event",{runId:s,scenarioId:n.id});const h={runId:s,scenarioId:n.id,status:"error",results:o.map((d,l)=>({runId:s,scenarioId:n.id,status:"success",action:{type:"browser_view"},message:"Step completed"})),startedAt:i,completedAt:Date.now()};Q({source:"background",type:"automation/summary",summary:h})}finally{this.activeMockRuns.delete(t),a.warn("[Mock] ðŸ§¹ Cleaned up mock run",{sessionId:t,runId:s})}}delay(t){return new Promise(s=>{globalThis.setTimeout(s,t)})}}class Hr{constructor(){g(this,"tabGroupManager",new Us);g(this,"sessionManager");g(this,"actionExecutor",new Bs);g(this,"messageBus",new vt);g(this,"manusAppManager",new Ps);g(this,"socketBridge",null);g(this,"mockSocketBridge",null);this.sessionManager=new Os({tabGroupManager:this.tabGroupManager,onDisposeSession:(e,t)=>{var s;(s=this.socketBridge)==null||s.emitDisconnectSession(e,t)},onStopSession:e=>{var t;(t=this.socketBridge)==null||t.emitStopSession(e)},onResumeSession:(e,t)=>{var s;(s=this.socketBridge)==null||s.emitTakeOverSummary(e,t)}}),this.setupMessageBus(),$.isDev()||this.disableSidePanelAutoOpen(),this.registerRuntimeListeners(),this.registerLifecycleListeners(),this.registerTabChangeListener(),this.registerManusTokenWatcher(),this.registerKeepAlivePortListener(),this.initializeStorageAndSocketBridge(),this.manusAppManager.registerManusAppPolling()}setupMessageBus(){a.info("ðŸš€ Initializing MessageBus architecture"),this.messageBus.registerMiddleware(new Et),this.messageBus.registerMiddleware(new Ft(1e3));const e=new Hs(this.sessionManager,o=>this.broadcastTabStatus(o)),t=new $s(this.sessionManager),s=new Ws(()=>this.socketBridge,()=>this.mockSocketBridge,this.actionExecutor),n=new qs(this.tabGroupManager);this.messageBus.batchRegisterHandler(["popup/get-tab-status","extension/unauthorize-task"],e),this.messageBus.batchRegisterHandler(["extension/stop-task","extension/resume-task","extension/unauthorize-task","content/heartbeat"],t),this.messageBus.batchRegisterHandler(["automation/get-scenarios","automation/run-scenario","automation/stop-scenario","automation/run-mock-scenario","automation/stop-mock-scenario","automation/activate","automation/trigger-browser-action"],s),this.messageBus.batchRegisterHandler(["my-browser/ping","my-browser/switch-to-tab","my-browser/set-browser-settings"],n),a.info("âœ… MessageBus setup complete",{handlers:this.messageBus.getHandlerCount(),middlewares:this.messageBus.getMiddlewareCount()})}registerRuntimeListeners(){chrome.runtime.onInstalled.addListener(e=>{if(a.info("Extension installed or updated",{reason:e.reason,previousVersion:e.previousVersion}),e.reason==="install"){const{onboardingUrl:t}=$.getEnvParams();try{const s=chrome.tabs.create({url:t});s&&typeof s.catch=="function"&&s.catch(n=>{a.error("Failed to open onboarding tab after install",n)})}catch(s){a.error("Error opening onboarding tab after install",s)}}}),this.messageBus.attach()}async initializeStorageAndSocketBridge(){a.info("Initializing extension storage and socket bridge");try{const{token:e,initialized:t}=await oe.initialize();a.info("Extension Storage initialized",{token:e,initialized:t}),a.info("User token initialized",{token:e}),await this.startSocketBridge(),a.info("Background service worker initialized. Connected to SocketBridge")}catch(e){const t=e instanceof Error?e.message:String(e);console.error("error:",e),a.error("Failed to initialize extension storage",{error:t})}}async startSocketBridge(){this.socketBridge=new mt(this.sessionManager,this.actionExecutor,this.tabGroupManager),a.info("Starting real SocketBridge"),await this.socketBridge.connectSocket(),this.mockSocketBridge=new qr(this.sessionManager,this.actionExecutor,this.tabGroupManager),a.info("Starting MockSocketBridge for local testing"),await this.mockSocketBridge.connectSocket()}registerTabChangeListener(){chrome.tabs.onActivated.addListener(e=>{this.broadcastTabStatus(e.tabId)})}broadcastTabStatus(e){const t=this.sessionManager.getSession({tabId:e}),s={source:"background",type:"popup/tab-status-update",activeTabId:e,sessionMeta:t?{sessionId:t.sessionId,status:t.status}:null};kt(s)}registerLifecycleListeners(){chrome.runtime.onSuspend.addListener(()=>{a.info("Extension suspending, cleaning up resources"),this.messageBus.detach(),gs().catch(e=>{a.error("Failed to cleanup CDP sessions on suspension",e)}),oe.stopWatcher()})}registerManusTokenWatcher(){oe.startWatcher()}registerKeepAlivePortListener(){chrome.runtime.onConnect.addListener(e=>{var t,s;e.name==="keep-alive"&&(a.debug("Keep-alive port connected",{tabId:(s=(t=e.sender)==null?void 0:t.tab)==null?void 0:s.id}),e.onMessage.addListener(n=>{var o,i;n.status==="ping"&&a.debug("Keep-alive ping received",{tabId:(i=(o=e.sender)==null?void 0:o.tab)==null?void 0:i.id})}),e.onDisconnect.addListener(()=>{var n,o;a.debug("Keep-alive port disconnected",{tabId:(o=(n=e.sender)==null?void 0:n.tab)==null?void 0:o.id})}))})}disableSidePanelAutoOpen(){if(a.info("Disabling side panel auto-open behavior"),!chrome.sidePanel){a.warn("Side panel API unavailable");return}typeof chrome.sidePanel.setPanelBehavior=="function"&&chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!1},()=>{chrome.runtime.lastError?a.warn("Failed to disable side panel auto-open",chrome.runtime.lastError):a.info("Side panel auto-open disabled - popup will show instead")})}}new Hr;
