import{y as t,z as n,u as i,q as e}from"./permissions-DQjjgS8V.js";import{aD as r,aE as o,aF as s,aG as a,aH as u,aI as c,aJ as l,aK as d,aL as h,aM as v,aN as f,aO as p,aP as g,aQ as m,aR as y,aS as w,aT as b,aU as z}from"./Main-iyJ1wi9k.js";import{i as S}from"./is-plan-event-enabled-CTGFxau4.js";function _(t){return t.toLowerCase().replace(".","").replace(/\s+/g,"-")}function P(t,n){return void 0===n&&(n=!1),n?btoa(t).replace(/=/g,""):void 0}function I(e,s,a,u){return t(this,void 0,void 0,function(){var t,c,l,d,h,v;return n(this,function(n){switch(n.label){case 0:t=_(s),c=P(t,u),l=o(),d="".concat(l,"/integrations/").concat(null!=c?c:t,"/").concat(a,"/").concat(null!=c?c:t,".dynamic.js.gz"),n.label=1;case 1:return n.trys.push([1,3,,4]),[4,r(d)];case 2:return n.sent(),function(t,n,e){var r,o;try{var s=(null!==(o=null===(r=null===window||void 0===window?void 0:window.performance)||void 0===r?void 0:r.getEntriesByName(t,"resource"))&&void 0!==o?o:[])[0];s&&n.stats.gauge("legacy_destination_time",Math.round(s.duration),i([e],s.duration<100?["cached"]:[],!0))}catch(a){}}(d,e,s),[3,4];case 3:throw h=n.sent(),e.stats.gauge("legacy_destination_time",-1,["plugin:".concat(s),"failed"]),h;case 4:return v=window["".concat(t,"Deps")],[4,Promise.all(v.map(function(t){return r(l+t+".gz")}))];case 5:return n.sent(),window["".concat(t,"Loader")](),[2,window["".concat(t,"Integration")]]}})})}function N(i,e){return t(this,void 0,void 0,function(){var r,o=this;return n(this,function(s){switch(s.label){case 0:return r=[],u()?[2,e]:[4,y(function(){return e.length>0&&z()},function(){return t(o,void 0,void 0,function(){var t,o;return n(this,function(n){switch(n.label){case 0:return(t=e.pop())?[4,w(t,i)]:[2];case 1:return o=n.sent(),o instanceof b||r.push(t),[2]}})})})];case 1:return s.sent(),r.map(function(t){return e.pushWithBackoff(t)}),[2,e]}})})}var k=function(){function i(t,n,i,r,o,s){void 0===r&&(r={});var a=this;this.options={},this.type="destination",this.middleware=[],this.initializePromise=p(),this.flushing=!1,this.name=t,this.version=n,this.settings=e({},r),this.disableAutoISOConversion=o.disableAutoISOConversion||!1,this.integrationSource=s,this.settings.type&&"browser"===this.settings.type&&delete this.settings.type,this.initializePromise.promise.then(function(t){return a._initialized=t},function(){}),this.options=o,this.buffer=o.disableClientPersistence?new g(4,[]):new m(4,"".concat(i,":dest-").concat(t)),this.scheduleFlush()}return i.prototype.isLoaded=function(){return!!this._ready},i.prototype.ready=function(){var t=this;return this.initializePromise.promise.then(function(){var n;return null!==(n=t.onReady)&&void 0!==n?n:Promise.resolve()})},i.prototype.load=function(i,e){var r;return t(this,void 0,void 0,function(){var t,o,s=this;return n(this,function(n){switch(n.label){case 0:return this._ready||void 0!==this.onReady?[2]:null===(r=this.integrationSource)||void 0===r?[3,1]:(o=r,[3,3]);case 1:return[4,I(i,this.name,this.version,this.options.obfuscate)];case 2:o=n.sent(),n.label=3;case 3:t=o,this.integration=function(t,n,i){var e;"Integration"in t?(t({user:function(){return i.user()},addIntegration:function(){}}),e=t.Integration):e=t;var r=new e(n);return r.analytics=i,r}(t,this.settings,e),this.onReady=new Promise(function(t){s.integration.once("ready",function(){s._ready=!0,t(!0)})}),this.integration.on("initialize",function(){s.initializePromise.resolve(!0)});try{a(i,{integrationName:this.name,methodName:"initialize",type:"classic"}),this.integration.initialize()}catch(u){throw a(i,{integrationName:this.name,methodName:"initialize",type:"classic",didError:!0}),this.initializePromise.resolve(!1),u}return[2]}})})},i.prototype.unload=function(i,e){return function(i,e,r){return t(this,void 0,void 0,function(){var t,a,u,c;return n(this,function(n){return t=o(),a=_(i),u=P(i,r),c="".concat(t,"/integrations/").concat(null!=u?u:a,"/").concat(e,"/").concat(null!=u?u:a,".dynamic.js.gz"),[2,s(c)]})})}(this.name,this.version,this.options.obfuscate)},i.prototype.addMiddleware=function(){for(var t,n=[],i=0;i<arguments.length;i++)n[i]=arguments[i];this.middleware=(t=this.middleware).concat.apply(t,n)},i.prototype.shouldBuffer=function(t){return"page"!==t.event.type&&(u()||!0!==this._ready||!0!==this._initialized)},i.prototype.send=function(i,r,o){var s,u;return t(this,void 0,void 0,function(){var t,d,h,v,f,p;return n(this,function(n){switch(n.label){case 0:return this.shouldBuffer(i)?(this.buffer.push(i),this.scheduleFlush(),[2,i]):(t=null===(u=null===(s=this.options)||void 0===s?void 0:s.plan)||void 0===u?void 0:u.track,d=i.event.event,t&&d&&"Segment.io"!==this.name&&(h=t[d],S(t,h)?i.updateEvent("integrations",e(e({},i.event.integrations),null==h?void 0:h.integrations)):(i.updateEvent("integrations",e(e({},i.event.integrations),{All:!1,"Segment.io":!0})),i.cancel(new c({retry:!1,reason:"Event ".concat(d," disabled for integration ").concat(this.name," in tracking plan"),type:"Dropped by plan"}))),(null==h?void 0:h.enabled)&&!1===(null==h?void 0:h.integrations[this.name])&&i.cancel(new c({retry:!1,reason:"Event ".concat(d," disabled for integration ").concat(this.name," in tracking plan"),type:"Dropped by plan"}))),[4,l(this.name,i.event,this.middleware)]);case 1:if(null===(v=n.sent()))return[2,i];f=new r(v,{traverse:!this.disableAutoISOConversion}),a(i,{integrationName:this.name,methodName:o,type:"classic"}),n.label=2;case 2:return n.trys.push([2,5,,6]),this.integration?[4,this.integration.invoke.call(this.integration,o,f)]:[3,4];case 3:n.sent(),n.label=4;case 4:return[3,6];case 5:throw p=n.sent(),a(i,{integrationName:this.name,methodName:o,type:"classic",didError:!0}),p;case 6:return[2,i]}})})},i.prototype.track=function(i){return t(this,void 0,void 0,function(){return n(this,function(t){return[2,this.send(i,d.Track,"track")]})})},i.prototype.page=function(i){var e;return t(this,void 0,void 0,function(){return n(this,function(t){switch(t.label){case 0:return(null===(e=this.integration)||void 0===e?void 0:e._assumesPageview)&&!this._initialized&&this.integration.initialize(),[4,this.initializePromise.promise];case 1:return t.sent(),[2,this.send(i,d.Page,"page")]}})})},i.prototype.identify=function(i){return t(this,void 0,void 0,function(){return n(this,function(t){return[2,this.send(i,d.Identify,"identify")]})})},i.prototype.alias=function(i){return t(this,void 0,void 0,function(){return n(this,function(t){return[2,this.send(i,d.Alias,"alias")]})})},i.prototype.group=function(i){return t(this,void 0,void 0,function(){return n(this,function(t){return[2,this.send(i,d.Group,"group")]})})},i.prototype.scheduleFlush=function(){var i=this;this.flushing||setTimeout(function(){return t(i,void 0,void 0,function(){var t;return n(this,function(n){switch(n.label){case 0:return u()||!0!==this._ready||!0!==this._initialized?(this.scheduleFlush(),[2]):(this.flushing=!0,t=this,[4,N(this,this.buffer)]);case 1:return t.buffer=n.sent(),this.flushing=!1,this.buffer.todo>0&&this.scheduleFlush(),[2]}})})},5e3*Math.random())},i}();function E(t,n,r,o,s,a){var u,c;if(void 0===r&&(r={}),void 0===o&&(o={}),h())return[];n.plan&&((o=null!=o?o:{}).plan=n.plan);var l=null!==(c=null===(u=n.middlewareSettings)||void 0===u?void 0:u.routingRules)&&void 0!==c?c:[],d=n.integrations,p=o.integrations,g=v(n,null!=o?o:{}),m=null==a?void 0:a.reduce(function(t,n){var i;return e(e({},t),((i={})[function(t){return("Integration"in t?t.Integration:t).prototype.name}(n)]=n,i))},{}),y=new Set(i(i([],Object.keys(d).filter(function(t){return function(t,n){var i,e=n.type,r=n.bundlingStatus,o=n.versionSettings,s="unbundled"!==r&&("browser"===e||(null===(i=null==o?void 0:o.componentTypes)||void 0===i?void 0:i.includes("browser")));return!t.startsWith("Segment")&&"Iterable"!==t&&s}(t,d[t])}),!0),Object.keys(m||{}).filter(function(t){return f(d[t])||f(null==p?void 0:p[t])}),!0));return Array.from(y).filter(function(t){return!function(t,n){var i=!1===n.All&&void 0===n[t];return!1===n[t]||i}(t,r)}).map(function(n){var i=function(t){var n,i,e,r;return null!==(r=null!==(i=null===(n=null==t?void 0:t.versionSettings)||void 0===n?void 0:n.override)&&void 0!==i?i:null===(e=null==t?void 0:t.versionSettings)||void 0===e?void 0:e.version)&&void 0!==r?r:"latest"}(d[n]),e=new k(n,i,t,g[n],o,null==m?void 0:m[n]);return l.filter(function(t){return t.destinationName===n}).length>0&&s&&e.addMiddleware(s),e})}export{k as LegacyDestination,E as ajsDestinations};
